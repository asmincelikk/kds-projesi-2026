<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A101 Ege BÃ¶lge | Karar Destek Sistemi</title>
    
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00bcd4;
            --primary-dark: #00acc1;
            --sidebar-width: 240px;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f4f7fe;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: white;
            border-right: 1px solid #e8ecef;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #e8ecef;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: contain;
        }

        .sidebar-brand {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
        }

        .sidebar-nav {
            padding: 16px 12px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            color: #697a8d;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f4f7fe;
            color: var(--primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .nav-item i {
            font-size: 18px;
            width: 24px;
        }

        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: #00aebb;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 24px;
            z-index: 999;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f4f7fe;
            border-radius: 10px;
            padding: 10px 16px;
            width: 280px;
        }

        .search-box i {
            color: #697a8d;
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            width: 100%;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f4f7fe;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #697a8d;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .header-icon:hover {
            background: var(--primary);
            color: white;
        }

        .header-icon .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px 6px 6px;
            background: #f4f7fe;
            border-radius: 30px;
            cursor: pointer;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            line-height: 1.2;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .user-role {
            font-size: 11px;
            color: #697a8d;
        }

        .main-content {
            margin-left: 0;
            margin-top: 60px;
            padding: 24px;
            min-height: calc(100vh - 60px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a2e;
        }

        .page-subtitle {
            font-size: 13px;
            color: #697a8d;
            margin-top: 4px;
        }

        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #697a8d;
        }

        .breadcrumb-nav a {
            color: var(--primary);
            text-decoration: none;
        }

       
        .card {
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
        }

        .card-header {
            background: transparent;
            border-bottom: none;
            padding: 20px 20px 0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0;
        }

        .card-body {
            padding: 20px;
        }

       
        .main-chart-area {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 4px;
            padding: 24px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .chart-placeholder {
            height: 280px;
            background: linear-gradient(180deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 188, 212, 0.02) 100%);
            border-radius: 12px;
            display: flex;
            align-items: flex-end;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .chart-placeholder::before {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 60%;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 188, 212, 0.15) 100%);
            border-radius: 8px 8px 0 0;
        }

        .chart-line {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: var(--primary);
        }

        .side-stats {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stat-box {
            background: white;
            border-radius: 4px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-info h4 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .stat-info h4.cyan { color: var(--primary); }
        .stat-info h4.green { color: #10b981; }
        .stat-info h4.orange { color: #f59e0b; }

        .stat-info p {
            font-size: 12px;
            color: #697a8d;
            margin: 4px 0 0;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.cyan { background: #e0f7fa; color: var(--primary); }
        .stat-icon.green { background: #d1fae5; color: #10b981; }
        .stat-icon.orange { background: #fef3c7; color: #f59e0b; }

        .mini-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .mini-stat-card {
            background: white;
            border-radius: 4px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
        }

        .mini-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .mini-stat-title {
            font-size: 13px;
            color: #697a8d;
            font-weight: 500;
        }

        .mini-stat-value {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .mini-stat-value h3 {
            font-size: 22px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0;
        }

        .mini-stat-value span {
            font-size: 12px;
            font-weight: 500;
        }

        .mini-stat-value span.up { color: #10b981; }
        .mini-stat-value span.down { color: #ef4444; }

        .mini-chart {
            height: 40px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
        }

        .mini-chart-bar {
            flex: 1;
            background: #e8ecef;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .mini-chart-bar.active {
            background: var(--primary);
        }

        .mini-chart-line {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, rgba(0, 188, 212, 0.2) 100%);
            border-radius: 4px;
            position: relative;
        }

    
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
        }

        .bottom-card {
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
            overflow: hidden;
        }

        .bottom-card-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bottom-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .bottom-card-body {
            padding: 20px;
        }

       
        .sales-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .sales-card .bottom-card-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .sales-card .bottom-card-title {
            color: white;
        }

        .sales-header-info {
            display: flex;
            gap: 24px;
        }

        .sales-header-info div {
            text-align: center;
        }

        .sales-header-info span {
            font-size: 11px;
            opacity: 0.8;
        }

        .sales-header-info strong {
            font-size: 14px;
            display: block;
        }

        .sales-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .sales-chart-placeholder {
            height: 120px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding-top: 20px;
        }

        .sales-bar {
            flex: 1;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px 4px 0 0;
        }

       
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f4f7fe;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .activity-avatar.cyan { background: #e0f7fa; color: var(--primary); }
        .activity-avatar.red { background: #fee2e2; color: #ef4444; }
        .activity-avatar.green { background: #d1fae5; color: #10b981; }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 13px;
            font-weight: 500;
            color: #1a1a2e;
        }

        .activity-subtitle {
            font-size: 12px;
            color: #697a8d;
        }

        .timeline-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            position: relative;
        }

        .timeline-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 4px;
        }

        .timeline-dot.cyan { background: var(--primary); }
        .timeline-dot.gray { background: #e8ecef; }
        .timeline-dot.red { background: #ef4444; }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-size: 13px;
            font-weight: 500;
            color: #1a1a2e;
        }

        .timeline-desc {
            font-size: 12px;
            color: #697a8d;
        }

        .timeline-link {
            color: var(--primary);
            font-size: 12px;
            text-decoration: none;
        }

        
        .horizontal-nav {
            background: white;
            border-bottom: 1px solid #e8ecef;
            padding: 0 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            top: 60px;
            z-index: 99;
        }
        
        .nav-item {
            padding: 14px 24px;
            font-size: 13px;
            font-weight: 600;
            color: #697a8d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-item:hover {
            color: #00aebb;
            background: rgba(0, 174, 187, 0.05);
        }
        
        .nav-item.active {
            color: #00aebb;
            border-bottom-color: #00aebb;
            background: rgba(0, 174, 187, 0.08);
        }
        
        .nav-item i {
            font-size: 16px;
        }
        
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 4px;
            padding: 24px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        .kpi-card.primary { border-left-color: #00aebb; }
        .kpi-card.danger { border-left-color: #dc3545; }
        .kpi-card.warning { border-left-color: #f59e0b; }
        .kpi-card.info { border-left-color: #6366f1; }
        
        .kpi-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .kpi-icon.primary { background: #e0f7fa; color: #00aebb; }
        .kpi-icon.danger { background: #fee2e2; color: #dc3545; }
        .kpi-icon.warning { background: #fef3c7; color: #f59e0b; }
        .kpi-icon.info { background: #e0e7ff; color: #6366f1; }
        
        .kpi-content {
            flex: 1;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 4px;
            line-height: 1;
        }
        
        .kpi-label {
            font-size: 13px;
            color: #697a8d;
            font-weight: 500;
        }
        
        .kpi-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .kpi-badge.danger { background: #fee2e2; color: #dc3545; }
        .kpi-badge.success { background: #d1fae5; color: #10b981; }
        
        
        .middle-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .module-card {
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
            overflow: hidden;
        }
        
        .module-header {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .module-title {
            font-size: 12px;
            font-weight: 600;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .module-title i {
            color: #00aebb;
            font-size: 14px;
        }
        
        .module-subtitle {
            font-size: 10px;
            color: #697a8d;
        }
        
        .module-body {
            padding: 10px;
        }
        
        
        #competitionMap {
            height: 200px;
            border-radius: 12px;
            z-index: 1;
        }
        
        .map-legend {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #697a8d;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .legend-item:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .legend-item.active {
            background: white;
            border-color: currentColor;
            font-weight: 600;
        }
        
        .legend-item.red { color: #dc3545; }
        .legend-item.orange { color: #f59e0b; }
        .legend-item.blue { color: #00aebb; }
        
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .legend-dot.red { background: #dc3545; }
        .legend-dot.blue { background: #00aebb; }
        .legend-dot.orange { background: #f59e0b; }
        
        .legend-section {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .legend-title {
            font-size: 10px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 8px;
        }
        
        .legend-section.rakip-legend {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid #e0e0e0;
        }
        
        .legend-item-static {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #697a8d;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.7);
        }
        
        .legend-square {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
            border: 1px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        
        @keyframes pulse-rakip {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }
        
        .rakip-marker-icon {
            animation: pulse-rakip 1.5s ease-in-out infinite;
        }
        
      
        .map-navigator {
            display: none;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding: 6px 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .map-navigator.active {
            display: flex;
        }
        
        .nav-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: #f4f7fe;
            color: #697a8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #00aebb;
            color: white;
        }
        
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .nav-info {
            font-size: 12px;
            font-weight: 600;
            color: #1a1a2e;
            min-width: 60px;
            text-align: center;
        }
        
        .nav-store-name {
            font-size: 11px;
            color: #697a8d;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .nav-action-buttons {
            display: flex;
            gap: 6px;
            margin-right: 8px;
            flex-direction: row;
            align-items: flex-end;
        }
        
        .nav-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: #00aebb;
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-action-btn:hover:not([style*="cursor: not-allowed"]) {
            background: #00889a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .nav-action-btn[style*="cursor: not-allowed"]:hover {
            transform: none;
            box-shadow: none;
        }
        
        .nav-action-btn i {
            font-size: 12px;
        }
        
        .nav-select-wrapper {
            display: flex;
            flex-direction: column;
        }
        
        .nav-selected-label {
            font-size: 9px;
            color: #697a8d;
            margin-bottom: 2px;
        }
        
        .nav-select-container {
            position: relative;
        }
        
        .nav-select {
            width: 100%;
        }
        
        .nav-close {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: #fee2e2;
            color: #dc3545;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .nav-close:hover {
            background: #dc3545;
            color: white;
        }
        
        
        .master-card {
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: none;
            margin-top: 16px;
        }
        
        .master-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .master-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .master-title i {
            color: #00aebb;
            font-size: 22px;
        }
        
        .master-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .master-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        .master-stat-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .master-stat-dot.green { background: #10b981; }
        .master-stat-dot.blue { background: #00aebb; }
        .master-stat-dot.red { background: #dc3545; }
        
        .master-stat-value {
            font-weight: 700;
            font-size: 13px;
            color: #1a1a2e;
        }
        
        .master-stat-label {
            font-size: 10px;
            color: #697a8d;
        }
        
        .master-filter-btn {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .master-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .master-filter-btn.active {
            border-color: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        
        .master-filter-btn.dimmed {
            opacity: 0.4;
        }
        
        .master-body {
            padding: 12px;
        }
        
        .master-chart-scroll {
            height: 300px;
            overflow-y: scroll;
            overflow-x: hidden;
            border-radius: 8px;
            background: #fafbfc;
            padding: 12px 8px;
            position: relative;
        }
        
        .master-chart-scroll::-webkit-scrollbar {
            width: 10px;
        }
        
        .master-chart-scroll::-webkit-scrollbar-track {
            background: #e8ecef;
            border-radius: 5px;
        }
        
        .master-chart-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00aebb 0%, #00939e 100%);
            border-radius: 5px;
            border: 2px solid #e8ecef;
        }
        
        .master-chart-scroll::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00939e 0%, #007a82 100%);
        }
        
        #masterChartWrapper {
            position: relative;
            min-height: 100%;
        }
        
        #masterChart {
            width: 100% !important;
        }
        
        .bottom-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .chart-container {
            height: 140px;
            position: relative;
        }
        
        .chart-container[style*="height: 160px"] {
            height: 160px !important;
        }
       
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #697a8d;
        }
        
        .loading-spinner i {
            font-size: 32px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

      
        @media (max-width: 1400px) {
            .main-chart-area {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .mini-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .bottom-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .mini-stats-row {
                grid-template-columns: 1fr;
            }
            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .master-stats {
                gap: 8px;
            }
        }
        
        
        .karsilastirma-mod-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #697a8d;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .karsilastirma-mod-btn:hover {
            border-color: #00aebb;
            color: #00aebb;
            background: rgba(0, 174, 187, 0.05);
        }
        
        .karsilastirma-mod-btn.active {
            border-color: #00aebb;
            background: #00aebb;
            color: white;
        }
        
        .karsilastirma-scorecard {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .karsilastirma-scorecard .score-label {
            font-size: 12px;
            color: #697a8d;
            font-weight: 600;
        }
        
        .karsilastirma-scorecard .score-values {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
            justify-content: space-between;
        }
        
        .karsilastirma-scorecard .score-value {
            font-size: 24px;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 8px;
        }
        
        .karsilastirma-scorecard .score-value.winner {
            background: #d1fae5;
            color: #059669;
        }
        
        .karsilastirma-scorecard .score-value.loser {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .karsilastirma-scorecard .score-gap {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a2e;
            padding: 6px 12px;
            background: #e0f2fe;
            border-radius: 6px;
        }
        
        .karsilastirma-progress-block {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .karsilastirma-progress-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .karsilastirma-progress-label {
            min-width: 120px;
            font-size: 12px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .karsilastirma-progress-bar-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .karsilastirma-progress-bar {
            flex: 1;
            height: 24px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            background: #f1f5f9;
        }
        
        .karsilastirma-progress-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }
        
        .karsilastirma-progress-fill.winner {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .karsilastirma-progress-fill.loser {
            background: linear-gradient(90deg, #dc3545 0%, #b91c1c 100%);
        }
        
        .karsilastirma-ik-block {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .karsilastirma-ik-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .karsilastirma-ik-card .ik-label {
            font-size: 11px;
            color: #697a8d;
            font-weight: 600;
        }
        
        .karsilastirma-ik-card .ik-values {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .karsilastirma-ik-card .ik-value {
            font-size: 20px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        .karsilastirma-ik-card .ik-value.winner {
            background: #d1fae5;
            color: #059669;
        }
        
        .karsilastirma-ik-card .ik-value.loser {
            background: #fee2e2;
            color: #dc2626;
        }
        
        
        .karsilastirma-column-standalone {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        
        .karsilastirma-column-header {
            padding: 8px 12px;
            background: #f8fafc;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        
        
        .karsilastirma-modul-card {
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        
        .karsilastirma-modul-title {
            padding: 8px 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e0e0e0;
            font-size: 11px;
            font-weight: 600;
            color: #1a1a2e;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        
        .karsilastirma-grafik {
            padding: 12px;
            background: white;
        }
        
        @media (max-width: 480px) {
            .kpi-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <header class="top-header">
        <span style="font-size: 17px; font-weight: 700; color: white; letter-spacing: 1px; text-align: center; width: 100%;">A101 EGE BÃ–LGE YÃ–NETÄ°CÄ°SÄ° KDS PANELÄ°</span>
    </header>

    
    <nav class="horizontal-nav">
        <div class="nav-item active" data-page="gosterge-paneli" onclick="switchPage('gosterge-paneli')">
            <i class="bi bi-speedometer2"></i>
            GÃ¶sterge Paneli
        </div>
        <div class="nav-item" data-page="magaza-analizi" onclick="switchPage('magaza-analizi')">
            <i class="bi bi-shop-window"></i>
            MaÄŸaza Analizi
        </div>
        <div class="nav-item" data-page="karsilastirma" onclick="switchPage('karsilastirma')">
            <i class="bi bi-bar-chart-line"></i>
            KarÅŸÄ±laÅŸtÄ±rmalÄ± Analizler
        </div>
        <div class="nav-item" data-page="senaryo" onclick="switchPage('senaryo')">
            <i class="bi bi-lightbulb"></i>
            Senaryo Analizi
        </div>
        </nav>

    
    <main class="main-content" style="margin-top: 0;">
        
        
        <section id="page-magaza-analizi" class="page-section" style="display: none;">
            <div class="page-header">
                <div>
                    <h1 class="page-title">MaÄŸaza Analizi</h1>
                    <div id="selectedMagazaName" style="font-size: 16px; color: #00aebb; font-weight: 600; margin-top: 8px; display: none;">
                        <i class="bi bi-shop"></i> <span id="magazaNameText"></span>
                    </div>
            </div>
                <div class="breadcrumb-nav">
                    <a href="#"><i class="bi bi-house"></i></a>
                    <span>/</span>
                    <span>Dashboard</span>
                    <span>/</span>
                    <span style="color: #00aebb;">MaÄŸaza Analizi</span>
        </div>
            </div>
            
            
            <div class="search-container" style="margin-bottom: 24px;">
                <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    
                    <div style="position: relative; flex: 1; min-width: 300px;">
                        <i class="bi bi-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #697a8d; font-size: 18px;"></i>
                        <input type="text" 
                               id="magazaSearchInput" 
                               placeholder="MaÄŸaza adÄ±, ilÃ§e veya il ara..." 
                               style="width: 100%; padding: 14px 16px 14px 48px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.2s; outline: none;"
                               oninput="searchMagaza(this.value)"
                               onfocus="this.style.borderColor='#00aebb'"
                               onblur="this.style.borderColor='#e0e0e0'">
                        <div id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 4px; max-height: 400px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-calendar3" style="font-size: 18px; color: #00aebb;"></i>
                        <span style="font-weight: 600; color: #1a1a2e; white-space: nowrap;">DÃ¶nem:</span>
                        <select id="magazaYilFilter" onchange="loadAllMagazaCharts()" style="padding: 10px 16px; border: 2px solid #00aebb; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; font-weight: 500; min-width: 140px;">
                            <option value="all">ðŸ“… TÃ¼m YÄ±llar</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                </div>
            </div>
            
            
            <div id="selectedMagazaDetail" style="display: none;">
                
            </div>
            
            
            <div id="magazaInitialMessage" style="text-align: center; padding: 80px 20px; color: #697a8d;">
                <i class="bi bi-shop-window" style="font-size: 64px; color: #00aebb; margin-bottom: 20px; display: block;"></i>
                <h3 style="font-size: 20px; margin-bottom: 10px; color: #1a1a2e;">MaÄŸaza Ara</h3>
                <p>YukarÄ±daki arama Ã§ubuÄŸunu kullanarak maÄŸaza adÄ±, ilÃ§e veya il bazÄ±nda arama yapabilirsiniz.</p>
        </div>
        </section>

        
        <section id="page-karsilastirma" class="page-section" style="display: none;">
        <div class="page-header">
            <div>
                    <h1 class="page-title">KarÅŸÄ±laÅŸtÄ±rmalÄ± Analizler</h1>
            </div>
            <div class="breadcrumb-nav">
                <a href="#"><i class="bi bi-house"></i></a>
                <span>/</span>
                <span>Dashboard</span>
                    <span>/</span>
                    <span style="color: #00aebb;">KarÅŸÄ±laÅŸtÄ±rmalÄ± Analizler</span>
            </div>
        </div>

            
            <div style="margin-bottom: 12px; display: flex; justify-content: center; gap: 8px; align-items: center;">
                <span style="font-weight: 600; color: #1a1a2e; font-size: 12px;">Tip:</span>
                <button class="karsilastirma-mod-btn active" data-mod="magaza" onclick="selectKarsilastirmaMod('magaza')" style="padding: 6px 12px; font-size: 11px;">
                    <i class="bi bi-shop"></i> MaÄŸazalar
                </button>
                <button class="karsilastirma-mod-btn" data-mod="ilce" onclick="selectKarsilastirmaMod('ilce')" style="padding: 6px 12px; font-size: 11px;">
                    <i class="bi bi-geo-alt"></i> Ä°lÃ§eler
                </button>
                <button class="karsilastirma-mod-btn" data-mod="il" onclick="selectKarsilastirmaMod('il')" style="padding: 6px 12px; font-size: 11px;">
                    <i class="bi bi-map"></i> Ä°ller
                        </button>
                    </div>
            
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                    <div style="font-size: 11px; font-weight: 600; color: #00aebb; margin-bottom: 8px;">
                        <i class="bi bi-arrow-left-circle"></i> Sol
                </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <label style="font-size: 10px; font-weight: 600; color: #697a8d; margin-bottom: 4px; display: block;">
                                SeÃ§im
                            </label>
                            <select id="karsilastirmaSolSelect" style="width: 100%; padding: 6px 8px; border: 1px solid #00aebb; border-radius: 4px; font-size: 11px; background: white; cursor: pointer;">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; font-weight: 600; color: #697a8d; margin-bottom: 4px; display: block;">
                                BaÅŸlangÄ±Ã§
                            </label>
                            <select id="karsilastirmaSolDateBaslangic" style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 11px; background: white; cursor: pointer;">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; font-weight: 600; color: #697a8d; margin-bottom: 4px; display: block;">
                                BitiÅŸ
                            </label>
                            <select id="karsilastirmaSolDateBitis" style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 11px; background: white; cursor: pointer;">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                </div>
            </div>

                
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                    <div style="font-size: 11px; font-weight: 600; color: #f59e0b; margin-bottom: 8px;">
                        <i class="bi bi-arrow-right-circle"></i> SaÄŸ
                </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <label style="font-size: 10px; font-weight: 600; color: #697a8d; margin-bottom: 4px; display: block;">
                                SeÃ§im
                            </label>
                            <select id="karsilastirmaSagSelect" style="width: 100%; padding: 6px 8px; border: 1px solid #f59e0b; border-radius: 4px; font-size: 11px; background: white; cursor: pointer;">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                </div>
                        <div>
                            <label style="font-size: 10px; font-weight: 600; color: #697a8d; margin-bottom: 4px; display: block;">
                                BaÅŸlangÄ±Ã§
                            </label>
                            <select id="karsilastirmaSagDateBaslangic" style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 11px; background: white; cursor: pointer;">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; font-weight: 600; color: #697a8d; margin-bottom: 4px; display: block;">
                                BitiÅŸ
                            </label>
                            <select id="karsilastirmaSagDateBitis" style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 11px; background: white; cursor: pointer;">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                    </div>
            </div>
        </div>

            
            <div style="text-align: center; margin-bottom: 16px;">
                <button id="karsilastirBtn" onclick="loadKarsilastirma()" style="padding: 8px 20px; background: linear-gradient(135deg, #00aebb 0%, #00889a 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="bi bi-arrow-left-right"></i> KarÅŸÄ±laÅŸtÄ±r
                </button>
                </div>
            
            
            <div id="karsilastirmaResults" style="display: none;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    
                    <div class="karsilastirma-column-standalone">
                        
                        <div class="karsilastirma-column-header">
                            <h3 id="karsilastirmaSolLabel" style="margin: 0; font-size: 13px; font-weight: 600; color: #00aebb;"></h3>
                </div>
                        
                        
                        <div class="karsilastirma-modul-card">
                            <div class="karsilastirma-modul-title">MODÃœL 1: KDS Performans Trendi</div>
                            <div class="karsilastirma-grafik">
                                <div style="height: 200px;">
                                    <canvas id="karsilastirmaPerformansChartSol"></canvas>
                </div>
            </div>
                </div>
                        
                        
                        <div class="karsilastirma-modul-card">
                            <div class="karsilastirma-modul-title">MODÃœL 2: Temel Metrikler</div>
                            <div class="karsilastirma-grafik" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">Toplam Ciro</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaCiroChartSol"></canvas>
                </div>
                </div>
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">Kira Maliyeti (%)</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaKiraChartSol"></canvas>
            </div>
                </div>
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">MÃ¼ÅŸteri Memnuniyeti</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaMemnuniyetChartSol"></canvas>
                </div>
                </div>
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">Personel Devir HÄ±zÄ± (%)</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaPersonelChartSol"></canvas>
            </div>
                </div>
                </div>
                        </div>
                        
                        
                        <div class="karsilastirma-modul-card">
                            <div class="karsilastirma-modul-title">MODÃœL 3: Hedef / GerÃ§ekleÅŸen Ciro Analizi</div>
                            <div class="karsilastirma-grafik">
                                <div style="height: 250px;">
                                    <canvas id="karsilastirmaHedefChartSol"></canvas>
                                </div>
                </div>
            </div>
        </div>

                    
                    <div class="karsilastirma-column-standalone">
                        
                        <div class="karsilastirma-column-header">
                            <h3 id="karsilastirmaSagLabel" style="margin: 0; font-size: 13px; font-weight: 600; color: #f59e0b;"></h3>
                        </div>
                        
                        
                        <div class="karsilastirma-modul-card">
                            <div class="karsilastirma-modul-title">MODÃœL 1: KDS Performans Trendi</div>
                            <div class="karsilastirma-grafik">
                                <div style="height: 200px;">
                                    <canvas id="karsilastirmaPerformansChartSag"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="karsilastirma-modul-card">
                            <div class="karsilastirma-modul-title">MODÃœL 2: Temel Metrikler</div>
                            <div class="karsilastirma-grafik" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">Toplam Ciro</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaCiroChartSag"></canvas>
                                    </div>
                                </div>
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">Kira Maliyeti (%)</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaKiraChartSag"></canvas>
                                    </div>
                                </div>
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">MÃ¼ÅŸteri Memnuniyeti</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaMemnuniyetChartSag"></canvas>
                                    </div>
                                </div>
                                <div style="background: #f8fafc; padding: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 10px; font-weight: 600; margin-bottom: 4px; text-align: center;">Personel Devir HÄ±zÄ± (%)</div>
                                    <div style="height: 120px;">
                                        <canvas id="karsilastirmaPersonelChartSag"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="karsilastirma-modul-card">
                            <div class="karsilastirma-modul-title">MODÃœL 3: Hedef / GerÃ§ekleÅŸen Ciro Analizi</div>
                            <div class="karsilastirma-grafik">
                                <div style="height: 250px;">
                                    <canvas id="karsilastirmaHedefChartSag"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div id="karsilastirmaInitialMessage" style="text-align: center; padding: 80px 20px; color: #697a8d;">
                <i class="bi bi-arrow-left-right" style="font-size: 64px; color: #00aebb; margin-bottom: 20px; display: block;"></i>
                <h3 style="font-size: 20px; margin-bottom: 10px; color: #1a1a2e;">KarÅŸÄ±laÅŸtÄ±rma YapÄ±n</h3>
                <p>YukarÄ±dan mod seÃ§in, sol ve saÄŸ taraflara seÃ§imlerinizi yapÄ±n ve "KarÅŸÄ±laÅŸtÄ±r" butonuna tÄ±klayÄ±n.</p>
            </div>
        </section>

        
        <section id="page-senaryo" class="page-section" style="display: none;">
            <div class="page-header">
                        <div>
                    <h1 class="page-title">Senaryo Analizi (Stres Testi)</h1>
                        </div>
                <div class="breadcrumb-nav">
                    <a href="#"><i class="bi bi-house"></i></a>
                    <span>/</span>
                    <span>Dashboard</span>
                    <span>/</span>
                    <span style="color: #00aebb;">Senaryo Analizi</span>
                </div>
            </div>
            
            
            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-top: 24px;">
                
                
                <div class="module-card">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="bi bi-sliders"></i> Senaryo Parametreleri
                        </div>
                    </div>
                    <div class="module-body" style="padding: 20px;">
                        
                        
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-size: 13px; font-weight: 600; color: #1a1a2e;">
                                    Beklenen Ciro DeÄŸiÅŸimi
                                </label>
                                <span id="ciroValue" class="senaryo-badge" style="background: #00aebb; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">0%</span>
                            </div>
                            <input type="range" id="ciroSlider" min="-50" max="50" value="0" 
                                   style="width: 100%; height: 6px; border-radius: 3px; background: #e0e0e0; outline: none;"
                                   oninput="updateSenaryo()">
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #697a8d; margin-top: 4px;">
                                <span>-50%</span>
                                <span>+50%</span>
                            </div>
                        </div>
                        
                        
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-size: 13px; font-weight: 600; color: #1a1a2e;">
                                    Kira ArtÄ±ÅŸ OranÄ±
                                </label>
                                <span id="kiraValue" class="senaryo-badge" style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">0%</span>
                            </div>
                            <input type="range" id="kiraSlider" min="0" max="100" value="0" 
                                   style="width: 100%; height: 6px; border-radius: 3px; background: #e0e0e0; outline: none;"
                                   oninput="updateSenaryo()">
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #697a8d; margin-top: 4px;">
                                <span>0%</span>
                                <span>+100%</span>
                            </div>
                        </div>
                        
                        
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-size: 13px; font-weight: 600; color: #1a1a2e;">
                                    Personel Maliyet ArtÄ±ÅŸÄ±
                                </label>
                                <span id="personelValue" class="senaryo-badge" style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">0%</span>
                            </div>
                            <input type="range" id="personelSlider" min="0" max="100" value="0" 
                                   style="width: 100%; height: 6px; border-radius: 3px; background: #e0e0e0; outline: none;"
                                   oninput="updateSenaryo()">
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #697a8d; margin-top: 4px;">
                                <span>0%</span>
                                <span>+100%</span>
                            </div>
                        </div>
                        
                        
                        <button onclick="resetSenaryo()" style="width: 100%; padding: 10px; background: #e0e0e0; color: #1a1a2e; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                            <i class="bi bi-arrow-counterclockwise"></i> SÄ±fÄ±rla
                        </button>
                        
                        
                        <div class="module-card" style="margin-top: 20px;">
                            <div style="padding: 16px;">
                                <div style="font-size: 11px; color: #697a8d; margin-bottom: 8px;">Riskli MaÄŸaza SayÄ±sÄ± (KDS &lt; 50)</div>
                                <div id="riskliMagaza" style="font-size: 24px; font-weight: 700; color: #dc3545;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                        <div>

                    
                    <div class="module-card">
                        <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                            <div class="module-title">
                                <i class="bi bi-bar-chart-line"></i> MaÄŸaza Performans Senaryosu (Son 6 aylÄ±k veriler)
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <select id="senaryoKdsFilter" onchange="updateSenaryo()" style="padding: 6px 12px; border: 2px solid #00aebb; border-radius: 6px; font-size: 12px; background: white; cursor: pointer; font-weight: 500;">
                                    <option value="lowest">En DÃ¼ÅŸÃ¼k KDS PuanlÄ± 15 MaÄŸaza</option>
                                    <option value="highest">En YÃ¼ksek KDS PuanlÄ± 15 MaÄŸaza</option>
                                </select>
                            </div>
                            </div>
                        <div class="module-body" style="padding: 20px;">
                            <div style="height: 500px;">
                                <canvas id="senaryoChart"></canvas>
                            </div>
                            </div>
                            </div>
                            </div>
                            </div>
        </section>

        
        <section id="page-gosterge-paneli" class="page-section">
        <div class="page-header">
                        <div>
                    <h1 class="page-title">KDS Dashboard</h1>
                            </div>
            <div class="breadcrumb-nav">
                <a href="#"><i class="bi bi-house"></i></a>
                <span>/</span>
                <span>Dashboard</span>
                    <span>/</span>
                    <span style="color: #00aebb;">GÃ¶sterge Paneli</span>
                </div>
            </div>

        
        <div class="middle-row">
            
            <div class="module-card">
                <div class="module-header">
                        <div>
                        <div class="module-title">
                            <i class="bi bi-geo-alt-fill"></i>
                            Mekansal Rekabet Analizi
                </div>
                        <div class="module-subtitle">ModÃ¼l 1: Ä°Ã§ Rekabet (YamyamlÄ±k) | ModÃ¼l 2: DÄ±ÅŸ Rekabet (Rakipler)</div>
                            </div>
                    <button onclick="initModule1And2()" style="padding: 6px 12px; border: none; background: #00aebb; color: white; border-radius: 6px; font-size: 12px; cursor: pointer;">
                            <i class="bi bi-arrow-clockwise"></i> Yenile
                        </button>
                            </div>
                <div class="module-body">
                    <div id="competitionMap"></div>
                    <div class="map-legend">
                        <div class="legend-section">
                            <div class="legend-title">A101 MaÄŸazalarÄ±</div>
                            <div class="legend-item red" onclick="filterMapByType('red')" title="TÄ±kla ve gezin">
                                <div class="legend-dot red"></div>
                                <span>YamyamlÄ±k Riski</span>
                                <span id="countRed" style="font-weight:700; margin-left:4px;">(0)</span>
                            </div>
                            <div class="legend-item orange" onclick="filterMapByType('orange')" title="TÄ±kla - Rakipler gÃ¶rÃ¼nÃ¼r">
                                <div class="legend-dot orange"></div>
                                <span>YÃ¼ksek Rakip (3+)</span>
                                <span id="countOrange" style="font-weight:700; margin-left:4px;">(0)</span>
                            </div>
                            <div class="legend-item blue" onclick="filterMapByType('blue')" title="TÄ±kla ve gezin">
                                <div class="legend-dot blue"></div>
                                <span>Normal</span>
                                <span id="countBlue" style="font-weight:700; margin-left:4px;">(0)</span>
                </div>
            </div>
                        <div class="legend-section rakip-legend" id="rakipLegend" style="display:none;">
                            <div class="legend-title">Rakip MaÄŸazalar</div>
                            <div class="legend-item-static">
                                <div class="legend-square" style="background:#1e3a5f;"></div>
                                <span>BÄ°M</span>
        </div>
                            <div class="legend-item-static">
                                <div class="legend-square" style="background:#ff8c00;"></div>
                                <span>MÄ°GROS</span>
                            </div>
                            <div class="legend-item-static">
                                <div class="legend-square" style="background:#dc3545;"></div>
                                <span>ÅžOK</span>
                </div>
            </div>

                        
                        <div class="map-navigator" id="mapNavigator">
                            
                            <div class="nav-action-buttons" id="navActionButtons" style="display: flex; gap: 6px; margin-right: 8px; flex-direction: row; align-items: flex-end;">
                                
                                <div class="nav-select-wrapper">
                                    <div class="nav-selected-label" id="magaza1Label" style="font-size: 9px; color: #697a8d; margin-bottom: 2px; display: none;">1. MaÄŸaza: <span id="magaza1Name">-</span></div>
                                    <div class="nav-select-container">
                                        <select class="nav-select" id="magaza1Select" onchange="selectMagaza1(this.value)" style="padding: 6px 12px; border: 1px solid #00aebb; border-radius: 6px; background: white; color: #1a1a2e; font-size: 11px; font-weight: 600; cursor: pointer; min-width: 150px;">
                                            <option value="">1. MaÄŸazayÄ± SeÃ§</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="nav-select-wrapper">
                                    <div class="nav-selected-label" id="magaza2Label" style="font-size: 9px; color: #697a8d; margin-bottom: 2px; display: none;">2. MaÄŸaza: <span id="magaza2Name">-</span></div>
                                    <div class="nav-select-container">
                                        <select class="nav-select" id="magaza2Select" onchange="selectMagaza2(this.value)" style="padding: 6px 12px; border: 1px solid #f59e0b; border-radius: 6px; background: white; color: #1a1a2e; font-size: 11px; font-weight: 600; cursor: pointer; min-width: 150px;">
                                            <option value="">2. MaÄŸazayÄ± SeÃ§</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button class="nav-action-btn" id="karsilastirBtn" onclick="goToKarsilastirma(event)">
                                    <i class="bi bi-arrow-left-right"></i> KarÅŸÄ±laÅŸtÄ±r
                                </button>
                            </div>
                            
                            <button class="nav-btn" onclick="navigateStore(-1)" id="navPrev" title="Ã–nceki">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <div>
                                <div class="nav-info" id="navInfo">1 / 5</div>
                                <div class="nav-store-name" id="navStoreName">MaÄŸaza AdÄ±</div>
                </div>
                            <button class="nav-btn" onclick="navigateStore(1)" id="navNext" title="Sonraki">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button class="nav-close" onclick="closeNavigator()" title="Kapat">
                                <i class="bi bi-x"></i>
                            </button>
                            </div>
                            </div>
                            </div>
                            </div>
            
            
            <div class="module-card">
                <div class="module-header">
                    <div>
                        <div class="module-title">
                            <i class="bi bi-cash-stack"></i>
                            Kira/Ciro VerimliliÄŸi
                </div>
                        <div class="module-subtitle">ModÃ¼l 4: En yÃ¼ksek kira yÃ¼kÃ¼ne sahip 10 maÄŸaza</div>
            </div>
        </div>
                <div class="module-body">
                    <div class="chart-container" style="height: 280px;">
                        <canvas id="rentChart"></canvas>
                            </div>
                </div>
                </div>
            </div>

        
        <div class="bottom-row">
            
            <div class="module-card" style="grid-column: span 2;">
                <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                    <div>
                        <div class="module-title">
                            <i class="bi bi-bullseye"></i>
                            Hedef / GerÃ§ekleÅŸen Ciro Analizi
                </div>
                        <div class="module-subtitle">ModÃ¼l 3: Ä°lÃ§e bazlÄ± kategori performansÄ±</div>
                            </div>
                    <div class="hedef-filter-panel" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        
                        <select id="hedefYilFilter" style="padding: 6px 10px; border: 1px solid #e8ecef; border-radius: 6px; font-size: 11px; background: white; cursor: pointer; min-width: 110px;">
                            <option value="2025" selected>ðŸ“… 2025</option>
                            <option value="2024">ðŸ“… 2024</option>
                            <option value="2023">ðŸ“… 2023</option>
                        </select>
                        
                        <select id="hedefIlceFilter" style="padding: 6px 10px; border: 2px solid #00aebb; border-radius: 6px; font-size: 11px; background: white; cursor: pointer; min-width: 130px; font-weight: 500;">
                            <option value="">ðŸ“ Ä°lÃ§e SeÃ§iniz *</option>
                        </select>
                        
                        <select id="hedefDemografiFilter" style="padding: 6px 10px; border: 1px solid #e8ecef; border-radius: 6px; font-size: 11px; background: white; cursor: pointer; min-width: 120px;">
                            <option value="all">ðŸ‘¥ TÃ¼m Demografiler</option>
                        </select>
                        
                        <button id="hedefAnalizBtn" onclick="loadHedefAnalizi()" style="padding: 6px 12px; background: linear-gradient(135deg, #00aebb 0%, #00889a 100%); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s;">
                            <i class="bi bi-search"></i> Analiz Et
                        </button>
                        
                        <div style="display: flex; gap: 6px; margin-left: 8px;">
                            <span style="padding: 5px 10px; background: #d1fae5; color: #10b981; border-radius: 5px; font-size: 10px; font-weight: 600;">
                                <i class="bi bi-check-circle"></i> Hedef Tutan: <span id="hedefTutan">0</span>
                            </span>
                            <span style="padding: 5px 10px; background: #fee2e2; color: #dc3545; border-radius: 5px; font-size: 10px; font-weight: 600;">
                                <i class="bi bi-x-circle"></i> Hedef AltÄ±: <span id="hedefAlti">0</span>
                            </span>
                            <span style="padding: 5px 10px; background: #e0f2fe; color: #0284c7; border-radius: 5px; font-size: 10px; font-weight: 600;">
                                <i class="bi bi-calendar"></i> DÃ¶nem: <span id="hedefDonem">-</span>
                            </span>
                            </div>
                            </div>
                            </div>
                <div class="module-body">
                    
                    <div id="hedefInitialMessage" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 140px; color: #94a3b8;">
                        <i class="bi bi-hand-index-thumb" style="font-size: 32px; margin-bottom: 10px; color: #00aebb;"></i>
                        <p style="font-size: 12px; margin: 0;">LÃ¼tfen bir <strong style="color: #00aebb;">ilÃ§e seÃ§in</strong> ve <strong style="color: #00aebb;">Analiz Et</strong> butonuna tÄ±klayÄ±n</p>
                        <p style="font-size: 10px; color: #b0bec5; margin-top: 4px;">Ä°lÃ§e bazlÄ± maÄŸaza kategori performansÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebilirsiniz</p>
                </div>
                    <div class="chart-container" style="height: 160px; display: none;" id="hedefChartContainer">
                        <canvas id="hedefChart"></canvas>
            </div>
        </div>
        </div>

            
            <div class="module-card">
                <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                        <div>
                        <div class="module-title">
                            <i class="bi bi-graph-up-arrow"></i>
                            Turistik BÃ¶lge Stok Trendi
                        </div>
                        <div class="module-subtitle">ModÃ¼l 5: Yaz aylarÄ±nda stok devir artÄ±ÅŸÄ±</div>
                        </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="logisticsYearFilter" onchange="initModule5()" style="padding: 6px 10px; border: 1px solid #e8ecef; border-radius: 6px; font-size: 11px; background: white; cursor: pointer;">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                        <select id="logisticsMagazaFilter" onchange="initModule5()" style="padding: 6px 10px; border: 1px solid #00aebb; border-radius: 6px; font-size: 11px; background: white; cursor: pointer; max-width: 160px;">
                            <option value="all">ðŸª TÃ¼m Turistik</option>
                        </select>
                    </div>
                </div>
                <div class="module-body">
                    <div class="chart-container">
                        <canvas id="logisticsChart"></canvas>
                    </div>
                    <div id="logisticsStats" style="display: flex; justify-content: center; gap: 12px; margin-top: 8px; font-size: 10px;">
                        <span style="padding: 3px 8px; background: #fef3c7; color: #d97706; border-radius: 5px;">
                            â˜€ï¸ Yaz Ort: <strong id="yazOrt">-</strong>
                        </span>
                        <span style="padding: 3px 8px; background: #e0f2fe; color: #0284c7; border-radius: 5px;">
                            â„ï¸ KÄ±ÅŸ Ort: <strong id="kisOrt">-</strong>
                        </span>
                        <span style="padding: 3px 8px; background: #d1fae5; color: #059669; border-radius: 5px;">
                            ðŸ“ˆ Fark: <strong id="mevsimFark">-</strong>
                        </span>
                    </div>
                </div>
            </div>

            
            <div class="module-card">
                <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                    <div>
                        <div class="module-title">
                            <i class="bi bi-people-fill"></i>
                            Personel & MÃ¼ÅŸteri
                </div>
                        <div class="module-subtitle">ModÃ¼l 6: Devir hÄ±zÄ± vs Memnuniyet</div>
                            </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <label style="font-size: 10px; color: #697a8d; white-space: nowrap;">BaÅŸlangÄ±Ã§:</label>
                        <input type="date" id="hrBaslangicTarihi" onchange="initModule6()" style="padding: 5px 8px; border: 1px solid #e8ecef; border-radius: 5px; font-size: 10px; background: white; cursor: pointer;">
                        <label style="font-size: 10px; color: #697a8d; white-space: nowrap;">BitiÅŸ:</label>
                        <input type="date" id="hrBitisTarihi" onchange="initModule6()" style="padding: 5px 8px; border: 1px solid #e8ecef; border-radius: 5px; font-size: 10px; background: white; cursor: pointer;">
                    </div>
                            </div>
                <div class="module-body" style="padding: 10px;">
                    <div class="chart-container" style="position: relative; height: 220px; padding-top: 10px;">
                        <canvas id="hrChart"></canvas>
                            </div>
                            </div>
                            </div>
                            </div>

        
        <div class="master-card">
            <div class="master-header">
                <div class="master-title">
                    <i class="bi bi-bar-chart-fill"></i>
                    Master Performans GrafiÄŸi - TÃ¼m MaÄŸazalar KDS SÄ±ralamasÄ±
                            </div>
                <div class="master-stats">
                    
                    <div class="master-stat" style="background: #fff3cd; border: 2px solid #f59e0b;">
                        <i class="bi bi-calendar3" style="color: #f59e0b; font-size: 14px;"></i>
                        <select id="masterDonemFilter" onchange="initMasterChart()" style="border: none; background: transparent; font-weight: 700; font-size: 12px; color: #1a1a2e; cursor: pointer; padding: 0 4px;">
                            <option value="12">Son 12 Ay</option>
                            <option value="6">Son 6 Ay</option>
                        </select>
                    </div>
                    
                    <div class="master-stat" style="background: #e0f2fe; border: 2px solid #0284c7;">
                        <i class="bi bi-sort-down" style="color: #0284c7; font-size: 14px;"></i>
                        <select id="masterSortFilter" onchange="applyMasterSort()" style="border: none; background: transparent; font-weight: 700; font-size: 12px; color: #1a1a2e; cursor: pointer; padding: 0 4px;">
                            <option value="desc">En Ä°yiler</option>
                            <option value="asc">En KÃ¶tÃ¼ler</option>
                        </select>
                    </div>
                    <div class="master-stat master-filter-btn" onclick="filterMasterChart('mukemmel')" title="TÄ±kla: MÃ¼kemmel maÄŸazalarÄ± gÃ¶ster">
                        <div class="master-stat-dot" style="background: #10b981;"></div>
                        <div>
                            <div class="master-stat-value" id="masterStatMukemmel">0</div>
                            <div class="master-stat-label">MÃ¼kemmel</div>
                        </div>
                    </div>
                    <div class="master-stat master-filter-btn" onclick="filterMasterChart('iyi')" title="TÄ±kla: Ä°yi maÄŸazalarÄ± gÃ¶ster">
                        <div class="master-stat-dot" style="background: #3b82f6;"></div>
                        <div>
                            <div class="master-stat-value" id="masterStatIyi">0</div>
                            <div class="master-stat-label">Ä°yi</div>
                        </div>
                    </div>
                    <div class="master-stat master-filter-btn" onclick="filterMasterChart('orta')" title="TÄ±kla: Orta maÄŸazalarÄ± gÃ¶ster">
                        <div class="master-stat-dot" style="background: #f59e0b;"></div>
                        <div>
                            <div class="master-stat-value" id="masterStatOrta">0</div>
                            <div class="master-stat-label">Orta</div>
                        </div>
                    </div>
                    <div class="master-stat master-filter-btn" onclick="filterMasterChart('kritik')" title="TÄ±kla: Kritik maÄŸazalarÄ± gÃ¶ster">
                        <div class="master-stat-dot" style="background: #f97316;"></div>
                        <div>
                            <div class="master-stat-value" id="masterStatKritik">0</div>
                            <div class="master-stat-label">Kritik</div>
                        </div>
                    </div>
                    <div class="master-stat master-filter-btn" onclick="filterMasterChart('acil')" title="TÄ±kla: Acil maÄŸazalarÄ± gÃ¶ster">
                        <div class="master-stat-dot red"></div>
                        <div>
                            <div class="master-stat-value" id="masterStatAcil">0</div>
                            <div class="master-stat-label">Acil</div>
                        </div>
                    </div>
                    <div class="master-stat master-filter-btn" id="masterFilterAll" onclick="filterMasterChart('all')" style="display: none; background: #e0f7fa; border: 2px solid #00aebb;" title="TÃ¼m maÄŸazalarÄ± gÃ¶ster">
                        <i class="bi bi-arrow-counterclockwise" style="color: #00aebb; font-size: 12px;"></i>
                        <div>
                            <div class="master-stat-value" style="color: #00aebb; font-size: 11px;">TÃ¼mÃ¼nÃ¼</div>
                            <div class="master-stat-label">GÃ¶ster</div>
                            </div>
                    </div>
                    <div class="master-stat" style="background: #e0f7fa;">
                        <div>
                            <div class="master-stat-value" id="masterStatAvg" style="color: #00aebb;">0</div>
                            <div class="master-stat-label">Ort. Puan</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="master-body">
                <div class="master-chart-scroll" id="masterChartScroll">
                    <div id="masterChartWrapper" style="width: 100%;">
                        <canvas id="masterChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        </section>
        
        
    </main>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        
        
        
        let competitionMap = null;
        let mapMarkers = [];
        let rentChart = null;
        let hedefChart = null;
        let logisticsChart = null;
        let hrChart = null;
        let masterChart = null;
        

        let categorizedStores = {
            red: [],    
            orange: [], 
            blue: []    
        };
        let currentCategory = null;
        let rakipMarkers = []; 
        let rakipLocationsData = []; 
        let highCompetitorStoreIds = new Set(); 
        let currentIndex = 0;
        
        
        const COLORS = {
            primary: '#00aebb',
            danger: '#dc3545',
            warning: '#f59e0b',
            success: '#10b981',
            info: '#6366f1'
        };
        
        let currentPage = 'gosterge-paneli';
        
        function switchPage(pageName) {
           
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });
            
            
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            
            
            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.style.display = 'block';
                
                
                if (pageName === 'magaza-analizi') {
                    const yilFilter = document.getElementById('magazaYilFilter');
                    if (yilFilter) {
                        yilFilter.value = '2025';
                    }
                }
            }
            
            currentPage = pageName;
            console.log(`ðŸ“„ Sayfa deÄŸiÅŸtirildi: ${pageName}`);
        }
        
        let searchTimeout = null;
        
        async function searchMagaza(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/analiz/arama?q=${encodeURIComponent(query)}`);
                    const result = await response.json();
                    
                    if (result.success && result.data.length > 0) {
                        resultsDiv.innerHTML = result.data.map(m => `
                            <div class="search-result-item" onclick="selectMagaza(${m.magaza_id})" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: all 0.2s;">
                                <div style="font-weight: 600; color: #1a1a2e;">${m.magaza_adi}</div>
                                <div style="font-size: 12px; color: #697a8d;">
                                    <i class="bi bi-geo-alt"></i> ${m.ilce_adi || '-'}, ${m.il_adi || '-'} 
                                    ${m.demografik_yapi ? `<span style="margin-left: 8px; padding: 2px 6px; background: #e0f2fe; color: #0284c7; border-radius: 4px; font-size: 10px;">${m.demografik_yapi}</span>` : ''}
                                </div>
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                        
                        
                        resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                            item.addEventListener('mouseenter', () => item.style.background = '#f8fafc');
                            item.addEventListener('mouseleave', () => item.style.background = 'white');
                        });
                    } else {
                        resultsDiv.innerHTML = '<div style="padding: 16px; color: #697a8d; text-align: center;">SonuÃ§ bulunamadÄ±</div>';
                        resultsDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Arama hatasÄ±:', error);
                }
            }, 300);
        }
        
        let selectedMagazaId = null;
        let magazaPerformansChart = null;
        
        
        function goToMagazaAnalizi(magazaId) {
            switchPage('magaza-analizi');
            
           
            setTimeout(() => {
                selectMagaza(magazaId);
            }, 100);
        }
        
        async function selectMagaza(magazaId) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('magazaSearchInput').value = '';
            document.getElementById('magazaInitialMessage').style.display = 'none';
            selectedMagazaId = magazaId;
            
            const detailDiv = document.getElementById('selectedMagazaDetail');
            detailDiv.style.display = 'block';
            detailDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="bi bi-hourglass-split" style="font-size: 32px; color: #00aebb;"></i><p>YÃ¼kleniyor...</p></div>';
            
            try {
                const response = await fetch(`/api/magazalar/${magazaId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const m = result.data;
                    
                    
                    const magazaNameDiv = document.getElementById('selectedMagazaName');
                    const magazaNameText = document.getElementById('magazaNameText');
                    if (magazaNameDiv && magazaNameText) {
                        magazaNameText.textContent = m.magaza_adi;
                        magazaNameDiv.style.display = 'block';
                    }
                    
                    detailDiv.innerHTML = `
                        
                        <div id="kdsAlertBox" style="margin-bottom: 24px; padding: 16px 20px; border-radius: 8px; display: none;">
                        </div>
                        
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            
                            <div class="module-card">
                                <div class="module-header">
                                    <div class="module-title"><i class="bi bi-bar-chart-line"></i> MaÄŸaza Denge GrafiÄŸi</div>
                                </div>
                                <div class="module-body" style="padding: 20px;">
                                    <div style="height: 300px;">
                                        <canvas id="magazaDivergingChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <div class="module-card">
                                <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                                    <div>
                                        <div class="module-title"><i class="bi bi-graph-up-arrow"></i> Kira ve Ciro Analizi</div>
                                        <div class="module-subtitle">Aylara gÃ¶re kira tutarÄ± ve ciro karÅŸÄ±laÅŸtÄ±rmasÄ±</div>
                                    </div>
                                </div>
                                <div class="module-body" style="padding: 20px;">
                                    <div style="height: 300px;">
                                        <canvas id="kiraCiroChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            
                            <div class="module-card">
                                <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                                    <div>
                                        <div class="module-title"><i class="bi bi-graph-up"></i> AylÄ±k KDS Performans GrafiÄŸi</div>
                                        <div class="module-subtitle">Aylara gÃ¶re KDS puanÄ± trendi</div>
                                    </div>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span id="avgKds" style="padding: 4px 8px; background: #d1fae5; color: #059669; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                            Ort: --
                                        </span>
                                        <span id="maxKds" style="padding: 4px 8px; background: #dbeafe; color: #2563eb; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                            Max: --
                                        </span>
                                        <span id="minKds" style="padding: 4px 8px; background: #fee2e2; color: #dc2626; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                            Min: --
                                        </span>
                                    </div>
                                </div>
                                <div class="module-body" style="padding: 12px;">
                                    <div style="height: 240px;">
                                        <canvas id="magazaPerformansChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <div class="module-card">
                                <div class="module-header" style="flex-wrap: wrap; gap: 6px;">
                                    <div>
                                        <div class="module-title"><i class="bi bi-bar-chart-steps"></i> Ä°l OrtalamasÄ± ile KarÅŸÄ±laÅŸtÄ±rma</div>
                                        <div class="module-subtitle" id="benchmarkSubtitle">SeÃ§ilen maÄŸaza vs il ortalamasÄ±</div>
                                    </div>
                                    <div id="benchmarkStats" style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: #e0f2fe; color: #0284c7; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                            Ä°l: <span id="benchmarkIl">--</span>
                                        </span>
                                        <span style="padding: 4px 8px; background: #f3f4f6; color: #374151; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                            KarÅŸÄ±laÅŸtÄ±rÄ±lan: <span id="benchmarkMagazaSayisi">--</span> maÄŸaza
                                        </span>
                                    </div>
                                </div>
                                <div class="module-body" style="padding: 12px;">
                                    <div style="height: 240px;">
                                        <canvas id="magazaBenchmarkChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    
                    loadAllMagazaCharts();
                }
            } catch (error) {
                console.error('MaÄŸaza detay hatasÄ±:', error);
                detailDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Hata oluÅŸtu</div>';
            }
        }
        
        let magazaKiraCiroChart = null;
        let magazaDivergingChart = null;
        let magazaBenchmarkChart = null;
        
        
        async function loadAllMagazaCharts() {
            await Promise.all([
                loadMagazaPerformans(),
                loadMagazaDetayliAnaliz(),
                loadMagazaBenchmark(),
                loadKiraCiroChart()
            ]);
        }
        
        async function loadMagazaDetayliAnaliz() {
            if (!selectedMagazaId) return;
            
            
            const yilFilter = document.getElementById('magazaYilFilter');
            const yil = (yilFilter && yilFilter.value && yilFilter.value !== 'all') ? yilFilter.value : '2025';
            
            try {
                const response = await fetch(`/api/analiz/magaza-detayli/${selectedMagazaId}?yil=${yil}`);
                const result = await response.json();
                
                if (result.success) {
                    
                    const alertBox = document.getElementById('kdsAlertBox');
                    if (alertBox && result.kdsOnerisi) {
                        const kds = result.kdsOnerisi;
                        let bgColor, textColor, icon;
                        
                        if (kds.renk === 'red') {
                            bgColor = '#fee2e2'; textColor = '#dc2626'; icon = 'ðŸš¨';
                        } else if (kds.renk === 'green') {
                            bgColor = '#d1fae5'; textColor = '#059669'; icon = 'âœ…';
                        } else {
                            bgColor = '#fef3c7'; textColor = '#d97706'; icon = 'âš ï¸';
                        }
                        
                        alertBox.style.background = bgColor;
                        alertBox.style.color = textColor;
                        alertBox.style.display = 'flex';
                        alertBox.style.alignItems = 'center';
                        alertBox.style.gap = '12px';
                        alertBox.style.border = `2px solid ${textColor}`;
                        alertBox.innerHTML = `
                            <span style="font-size: 24px;">${icon}</span>
                            <div>
                                <div style="font-weight: 700; font-size: 14px;">KDS Tavsiyesi (${kds.yil})</div>
                                <div style="font-size: 13px;">${kds.karar}</div>
                            </div>
                            <div style="margin-left: auto; text-align: right;">
                                <div style="font-size: 24px; font-weight: 700;">${kds.puan}</div>
                                <div style="font-size: 11px;">KDS PuanÄ±</div>
                            </div>
                        `;
                    }
                    
                    
                    try {
                        const divergingCtx = document.getElementById('magazaDivergingChart');
                        console.log('ðŸ“Š Diverging Chart:', { ctx: !!divergingCtx, data: result.diverging });
                        if (divergingCtx && result.diverging && result.diverging.length > 0) {
                            if (magazaDivergingChart) magazaDivergingChart.destroy();
                            
                            
                            const labels = result.diverging.map(d => d.label || '');
                            const data = result.diverging.map(d => {
                                const value = d.value;
                                return (value === null || value === undefined || isNaN(value)) ? 0 : value;
                            });
                            
                            
                            const colors = result.diverging.map(d => {
                                const value = d.value ?? 0;
                                const sinir = d.sinir ?? 0;
                                const category = d.category || 'success';
                                
                             
                                if (category === 'risk') {
                                    return value >= sinir ? '#dc3545' : '#198754';
                                }
                               
                                else {
                                    return value >= sinir ? '#198754' : '#dc3545';
                                }
                            });
                            
                           
                            const sinirCizgileri = result.diverging.map((d, index) => ({
                                type: 'line',
                                xMin: d.sinir,
                                xMax: d.sinir,
                                borderColor: '#6c757d',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'SÄ±nÄ±r: ' + d.sinir.toFixed(1),
                                    enabled: true,
                                    position: 'top'
                                }
                            }));
                            
                            const maxValue = Math.max(...data, 250); 
                            const maxX = Math.max(maxValue, 250);
                            
                            magazaDivergingChart = new Chart(divergingCtx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Normalize DeÄŸer',
                                    data: data,
                                    backgroundColor: colors,
                                    borderColor: colors,
                                    borderWidth: 1,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                        padding: 12,
                                        cornerRadius: 8,
                                        callbacks: {
                                            title: function(context) {
                                                return result.diverging[context[0].dataIndex].label;
                                            },
                                            label: function(context) {
                                                const d = result.diverging[context.dataIndex];
                                                const value = context.raw;
                                                return [
                                                    'Normalize: ' + value.toFixed(1),
                                                    'GerÃ§ek DeÄŸer: ' + (d.rawValue || value.toFixed(1)),
                                                    'SÄ±nÄ±r: ' + (d.sinir || 0).toFixed(1)
                                                ];
                                            }
                                        }
                                    },
                                },
                                scales: {
                                    x: {
                                        min: 0,
                                        max: maxX,
                                        beginAtZero: true,
                                        grid: {
                                            display: true,
                                            color: '#e8ecef'
                                        },
                                        ticks: {
                                            stepSize: 25,
                                            callback: function(value) {
                                                return value;
                                            },
                                            color: '#697a8d',
                                            font: { size: 10 }
                                        },
                                        title: {
                                            display: true,
                                            text: 'Normalize DeÄŸer (0-100+)',
                                            color: '#697a8d',
                                            font: { size: 11, weight: '600' }
                                        }
                                    },
                                    y: {
                                        grid: { 
                                            display: true,
                                            color: function(context) {
                                                
                                                const index = context.index;
                                                if (index !== undefined && result.diverging[index]) {
                                                    return 'transparent'; 
                                                }
                                                return '#e8ecef';
                                            }
                                        },
                                        ticks: {
                                            color: '#1a1a2e',
                                            font: { size: 11 }
                                        }
                                    }
                                }
                            },
                            plugins: [{
                                id: 'sÄ±nÄ±rCizgileri',
                                afterDraw: function(chart) {
                                    const ctx = chart.ctx;
                                    const xScale = chart.scales.x;
                                    const yScale = chart.scales.y;
                                    
                                    result.diverging.forEach((d, index) => {
                                        const xPos = xScale.getPixelForValue(d.sinir);
                                        const yPos = yScale.getPixelForValue(index);
                                        
                                        ctx.save();
                                        ctx.strokeStyle = '#6c757d';
                                        ctx.lineWidth = 1.5;
                                        ctx.setLineDash([5, 5]);
                                        ctx.beginPath();
                                        ctx.moveTo(xPos, yPos - yScale.height / (result.diverging.length * 2));
                                        ctx.lineTo(xPos, yPos + yScale.height / (result.diverging.length * 2));
                                        ctx.stroke();
                                        ctx.restore();
                                    });
                                }
                            }]
                        });
                        console.log('âœ… Diverging Chart oluÅŸturuldu');
                    }
                    } catch (err) {
                        console.error('âŒ Diverging Chart hatasÄ±:', err);
                    }
                    
                    
                    loadKiraCiroChart();
                }
            } catch (error) {
                console.error('âŒ DetaylÄ± analiz hatasÄ±:', error);
            }
        }
        
        async function loadMagazaPerformans() {
            if (!selectedMagazaId) return;
            
            const yil = document.getElementById('magazaYilFilter')?.value || 'all';
            const ctx = document.getElementById('magazaPerformansChart');
            if (!ctx) return;
            
            try {
                const response = await fetch(`/api/analiz/magaza-performans/${selectedMagazaId}?yil=${yil}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const data = result.data;
                    
                    
                    document.getElementById('avgKds').textContent = `Ort: ${result.istatistik.ortalama_kds}`;
                    document.getElementById('maxKds').textContent = `Max: ${result.istatistik.max_kds}`;
                    document.getElementById('minKds').textContent = `Min: ${result.istatistik.min_kds}`;
                    
                    const labels = data.map(d => d.donem_label);
                    const kdsData = data.map(d => d.kds_puani);
                    
                    if (magazaPerformansChart) magazaPerformansChart.destroy();
                    
                    magazaPerformansChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'KDS PuanÄ±',
                                data: kdsData,
                                fill: true,
                                borderColor: '#00aebb',
                                backgroundColor: 'rgba(0, 174, 187, 0.1)',
                                tension: 0.4,
                                pointRadius: 5,
                                pointBackgroundColor: kdsData.map(v => 
                                    v >= 80 ? '#10b981' : (v >= 50 ? '#f59e0b' : '#dc3545')
                                ),
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                borderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            const idx = context.dataIndex;
                                            const d = data[idx];
                                            return [
                                                `KDS PuanÄ±: ${d.kds_puani}`,
                                                `Ciro: ${d.toplam_ciro.toLocaleString('tr-TR')} â‚º`,
                                                `Memnuniyet: ${d.musteri_memnuniyet}/10`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { 
                                        color: '#697a8d', 
                                        font: { size: 10 },
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    min: 0,
                                    max: 100,
                                    grid: { color: '#f1f5f9' },
                                    ticks: { 
                                        color: '#697a8d', 
                                        font: { size: 11 }
                                    },
                                    title: {
                                        display: true,
                                        text: 'KDS PuanÄ±',
                                        color: '#697a8d',
                                        font: { size: 12 }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Performans grafiÄŸi hatasÄ±:', error);
            }
        }
        
        
        async function loadKiraCiroChart() {
            if (!selectedMagazaId) return;
            
            const yil = document.getElementById('magazaYilFilter')?.value || 'all';
            const ctx = document.getElementById('kiraCiroChart');
            if (!ctx) return;
            
            try {
                const response = await fetch(`/api/analiz/magaza-kira-ciro/${selectedMagazaId}?yil=${yil}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const data = result.data;
                    
                   
                    const labels = data.map(d => {
                        const date = new Date(d.donem_ay);
                        const ayAdlari = ['Oca', 'Åžub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                        return `${ayAdlari[date.getMonth()]} ${date.getFullYear()}`;
                    });
                    
                    const ciroData = data.map(d => parseFloat(d.toplam_ciro) || 0);
                    const kiraData = data.map(d => parseFloat(d.kira_gideri) || 0);
                    
                    if (magazaKiraCiroChart) magazaKiraCiroChart.destroy();
                    
                    magazaKiraCiroChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Toplam Ciro',
                                    data: ciroData,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointBackgroundColor: '#10b981',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2
                                },
                                {
                                    label: 'Kira TutarÄ±',
                                    data: kiraData,
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointBackgroundColor: '#dc3545',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: { size: 12, weight: '600' }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            const label = context.dataset.label;
                                            return `${label}: ${value.toLocaleString('tr-TR', { maximumFractionDigits: 0 })} â‚º`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 11 },
                                        color: '#697a8d'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        font: { size: 11 },
                                        color: '#697a8d',
                                        callback: function(value) {
                                            return (value / 1000).toFixed(0) + 'K â‚º';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('âœ… Kira ve Ciro Chart oluÅŸturuldu');
                } else {
                    console.warn('âš ï¸ Kira ve Ciro verisi bulunamadÄ±');
                }
            } catch (error) {
                console.error('âŒ Kira ve Ciro Chart hatasÄ±:', error);
            }
        }
        
        
        async function loadMagazaBenchmark() {
            if (!selectedMagazaId) return;
            
            const yil = document.getElementById('magazaYilFilter')?.value || 'all';
            const ctx = document.getElementById('magazaBenchmarkChart');
            if (!ctx) return;
            
            try {
                const response = await fetch(`/api/analiz/magaza-benchmark/${selectedMagazaId}?yil=${yil}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.metrikler) {
                    const benchmark = result.data;
                    
                    
                    document.getElementById('benchmarkIl').textContent = benchmark.ilAdi || '--';
                    document.getElementById('benchmarkMagazaSayisi').textContent = benchmark.magazaSayisi || '--';
                    
                
                    const labels = benchmark.metrikler.map(m => m.label);
                    const magazaData = benchmark.metrikler.map(m => {
                        if (m.ilOrtalama > 0) {
                            return (m.magaza / m.ilOrtalama) * 100; 
                        }
                        return 0;
                    });
                    const ilData = benchmark.metrikler.map(() => 100); 
                    
                    if (magazaBenchmarkChart) magazaBenchmarkChart.destroy();
                    
                    magazaBenchmarkChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'SeÃ§ilen MaÄŸaza (Ä°l OrtalamasÄ± = 100)',
                                    data: magazaData,
                                    backgroundColor: magazaData.map((v, idx) => {
                                        const metrik = benchmark.metrikler[idx];
                                        const label = metrik.label;
                                        if (label === 'Personel Devir HÄ±zÄ±' || label === 'Kira YÃ¼kÃ¼') {
                                            return v <= 100 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(220, 53, 69, 0.8)';
                                        }
                                       
                                        return v >= 100 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(220, 53, 69, 0.8)';
                                    }),
                                    borderColor: magazaData.map((v, idx) => {
                                        const metrik = benchmark.metrikler[idx];
                                        const label = metrik.label;
                                       
                                        if (label === 'Personel Devir HÄ±zÄ±' || label === 'Kira YÃ¼kÃ¼') {
                                            
                                            return v <= 100 ? '#10b981' : '#dc3545';
                                        }
                                        
                                        return v >= 100 ? '#10b981' : '#dc3545';
                                    }),
                                    borderWidth: 2,
                                    borderRadius: 6
                                },
                                {
                                    label: `${benchmark.ilAdi} Ä°l OrtalamasÄ± (100 = Referans)`,
                                    data: ilData,
                                    backgroundColor: 'rgba(156, 163, 175, 0.6)',
                                    borderColor: '#9ca3af',
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    borderDash: [5, 5]
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        font: { size: 11 },
                                        padding: 15
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        title: function(context) {
                                            return benchmark.metrikler[context[0].dataIndex].label;
                                        },
                                        label: function(context) {
                                            const idx = context.dataIndex;
                                            const datasetIndex = context.datasetIndex;
                                            const metrik = benchmark.metrikler[idx];
                                            const normalizedValue = context.raw;
                                            
                                            if (datasetIndex === 0) {
                                                
                                                let formattedValue;
                                                if (metrik.format === 'currency') {
                                                    formattedValue = metrik.magaza.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' â‚º';
                                                } else {
                                                    formattedValue = metrik.magaza.toFixed(1) + metrik.birim;
                                                }
                                                return [
                                                    `SeÃ§ilen MaÄŸaza: ${formattedValue}`,
                                                    `Ä°l ortalamasÄ±nÄ±n %${normalizedValue.toFixed(1)}'i`
                                                ];
                                            } else {
                                                
                                                let formattedValue;
                                                if (metrik.format === 'currency') {
                                                    formattedValue = metrik.ilOrtalama.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' â‚º';
                                                } else {
                                                    formattedValue = metrik.ilOrtalama.toFixed(1) + metrik.birim;
                                                }
                                                return `${benchmark.ilAdi} Ä°l OrtalamasÄ± (Referans): ${formattedValue}`;
                                            }
                                        },
                                        afterBody: function(context) {
                                            const idx = context[0].dataIndex;
                                            const metrik = benchmark.metrikler[idx];
                                            if (metrik.fark && metrik.fark != 0) {
                                                const farkPozitif = parseFloat(metrik.fark) > 0;
                                                return [
                                                    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
                                                    `Fark: ${farkPozitif ? '+' : ''}${metrik.fark}%`,
                                                    `Durum: Ä°l ortalamasÄ±nÄ±n ${metrik.durum}`
                                                ];
                                            }
                                            return '';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        color: '#697a8d',
                                        font: { size: 11 }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: '#f1f5f9',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#697a8d',
                                        font: { size: 10 },
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ä°l OrtalamasÄ±na GÃ¶re Performans (%)',
                                        color: '#697a8d',
                                        font: { size: 11, weight: '600' }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('âœ… Benchmark Chart oluÅŸturuldu');
                }
            } catch (error) {
                console.error('âŒ Benchmark grafiÄŸi hatasÄ±:', error);
            }
        }
        
        
        let currentKarsilastirmaMod = 'magaza';
        let karsilastirmaRadarSol = null;
        let karsilastirmaRadarSag = null;
        let karsilastirmaCharts = {
            performansSol: null, performansSag: null,
            ciroSol: null, ciroSag: null,
            kiraSol: null, kiraSag: null,
            personelSol: null, personelSag: null,
            memnuniyetSol: null, memnuniyetSag: null,
            hedefSol: null, hedefSag: null
        };
        
        
        let senaryoChart = null;
        let senaryoData = [];
        const ORTALAMA_PERSONEL_MALIYETI = 30000; 
        
        
        function selectKarsilastirmaMod(mod) {
            currentKarsilastirmaMod = mod;
            
            
            document.querySelectorAll('.karsilastirma-mod-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mod === mod) {
                    btn.classList.add('active');
                }
            });
            
            
            loadKarsilastirmaDropdowns();
        }
        
        
        async function loadKarsilastirmaDropdowns() {
            const solSelect = document.getElementById('karsilastirmaSolSelect');
            const sagSelect = document.getElementById('karsilastirmaSagSelect');
            
            if (!solSelect || !sagSelect) return;
            
            try {
                let url, optionText, optionValue;
                
                if (currentKarsilastirmaMod === 'magaza') {
                    const response = await fetch('/api/magazalar');
                    const result = await response.json();
                    if (result.success) {
                        solSelect.innerHTML = '<option value="">MaÄŸaza SeÃ§iniz...</option>' +
                            result.data.map(m => `<option value="${m.magaza_id}">${m.magaza_adi}</option>`).join('');
                        sagSelect.innerHTML = solSelect.innerHTML;
                    }
                } else if (currentKarsilastirmaMod === 'ilce') {
                    const response = await fetch('/api/analiz/ilceler');
                    const result = await response.json();
                    if (result.success) {
                        solSelect.innerHTML = '<option value="">Ä°lÃ§e SeÃ§iniz...</option>' +
                            result.data.map(i => `<option value="${i.ilce_id}">${i.ilce_adi} (${i.magaza_sayisi} maÄŸaza)</option>`).join('');
                        sagSelect.innerHTML = solSelect.innerHTML;
                    }
                } else if (currentKarsilastirmaMod === 'il') {
                    const response = await fetch('/api/analiz/iller');
                    const result = await response.json();
                    if (result.success) {
                        solSelect.innerHTML = '<option value="">Ä°l SeÃ§iniz...</option>' +
                            result.data.map(i => `<option value="${i.il_id}">${i.il_adi} (${i.magaza_sayisi} maÄŸaza)</option>`).join('');
                        sagSelect.innerHTML = solSelect.innerHTML;
                    }
                }
                
                
                const solDateBaslangic = document.getElementById('karsilastirmaSolDateBaslangic');
                const solDateBitis = document.getElementById('karsilastirmaSolDateBitis');
                const sagDateBaslangic = document.getElementById('karsilastirmaSagDateBaslangic');
                const sagDateBitis = document.getElementById('karsilastirmaSagDateBitis');
                
                if (solDateBaslangic && solDateBitis && sagDateBaslangic && sagDateBitis) {
                    try {
                        const tarihResponse = await fetch('/api/analiz/tarihler');
                        const tarihResult = await tarihResponse.json();
                        
                        if (tarihResult.success && tarihResult.data) {
                            const options = '<option value="">SeÃ§iniz...</option>' + 
                                tarihResult.data.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
                            
                            solDateBaslangic.innerHTML = options;
                            solDateBitis.innerHTML = options;
                            sagDateBaslangic.innerHTML = options;
                            sagDateBitis.innerHTML = options;
                        }
                    } catch (error) {
                        console.error('Tarih listesi yÃ¼kleme hatasÄ±:', error);
                    }
                }
            } catch (error) {
                console.error('Dropdown yÃ¼kleme hatasÄ±:', error);
            }
        }
        
        
        async function loadKarsilastirma() {
            const solId = document.getElementById('karsilastirmaSolSelect')?.value;
            const solDateBaslangic = document.getElementById('karsilastirmaSolDateBaslangic')?.value;
            const solDateBitis = document.getElementById('karsilastirmaSolDateBitis')?.value;
            const sagId = document.getElementById('karsilastirmaSagSelect')?.value;
            const sagDateBaslangic = document.getElementById('karsilastirmaSagDateBaslangic')?.value;
            const sagDateBitis = document.getElementById('karsilastirmaSagDateBitis')?.value;
            
            if (!solId || !solDateBaslangic || !solDateBitis || !sagId || !sagDateBaslangic || !sagDateBitis) {
                alert('âš ï¸ LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
                return;
            }
            
            const btn = document.getElementById('karsilastirBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> YÃ¼kleniyor...';
            btn.disabled = true;
            
            try {
                
                const url = `/api/analiz/karsilastir?type=${currentKarsilastirmaMod}&id1=${solId}&date1=${solDateBaslangic}&id2=${sagId}&date2=${sagDateBaslangic}&date1_end=${solDateBitis}&date2_end=${sagDateBitis}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('karsilastirmaInitialMessage').style.display = 'none';
                    document.getElementById('karsilastirmaResults').style.display = 'block';
                    
                    
                    const solDateRange = `${solDateBaslangic} - ${solDateBitis}`;
                    const sagDateRange = `${sagDateBaslangic} - ${sagDateBitis}`;
                    document.getElementById('karsilastirmaSolLabel').textContent = `${result.sol.label} (${solDateRange})`;
                    document.getElementById('karsilastirmaSagLabel').textContent = `${result.sag.label} (${sagDateRange})`;
                    
                    
                    renderAllKarsilastirmaCharts(result.sol, result.sag, solId, sagId, solDateBaslangic, solDateBitis, sagDateBaslangic, sagDateBitis);
                } else {
                    alert('KarÅŸÄ±laÅŸtÄ±rma yapÄ±lÄ±rken hata oluÅŸtu: ' + (result.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('KarÅŸÄ±laÅŸtÄ±rma hatasÄ±:', error);
                alert('KarÅŸÄ±laÅŸtÄ±rma yapÄ±lÄ±rken hata oluÅŸtu: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        
        async function renderAllKarsilastirmaCharts(sol, sag, solId, sagId, solDateBaslangic, solDateBitis, sagDateBaslangic, sagDateBitis) {
            
            Object.values(karsilastirmaCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            if (karsilastirmaRadarSol) karsilastirmaRadarSol.destroy();
            if (karsilastirmaRadarSag) karsilastirmaRadarSag.destroy();
            
            
            await renderPerformansChart('karsilastirmaPerformansChartSol', solId, solDateBaslangic, solDateBitis, '#00aebb');
            await renderPerformansChart('karsilastirmaPerformansChartSag', sagId, sagDateBaslangic, sagDateBitis, '#f59e0b');
            
            
            const maxCiro = Math.max(sol.genel.toplam_ciro || 0, sag.genel.toplam_ciro || 0);
            const maxKira = Math.max(sol.maliyet.kira_yuku || 0, sag.maliyet.kira_yuku || 0);
            const maxPersonel = Math.max(sol.ik.personel_devir || 0, sag.ik.personel_devir || 0);
           
            const maxMemnuniyet = 10;
            
            renderBarChart('karsilastirmaCiroChartSol', sol.genel.toplam_ciro, '#00aebb', 'Toplam Ciro', maxCiro);
            renderBarChart('karsilastirmaCiroChartSag', sag.genel.toplam_ciro, '#f59e0b', 'Toplam Ciro', maxCiro);
            
            renderBarChart('karsilastirmaKiraChartSol', sol.maliyet.kira_yuku, '#00aebb', 'Kira Maliyeti (%)', maxKira);
            renderBarChart('karsilastirmaKiraChartSag', sag.maliyet.kira_yuku, '#f59e0b', 'Kira Maliyeti (%)', maxKira);
            
            renderBarChart('karsilastirmaMemnuniyetChartSol', sol.ik.musteri_memnuniyet, '#00aebb', 'MÃ¼ÅŸteri Memnuniyeti', maxMemnuniyet);
            renderBarChart('karsilastirmaMemnuniyetChartSag', sag.ik.musteri_memnuniyet, '#f59e0b', 'MÃ¼ÅŸteri Memnuniyeti', maxMemnuniyet);
            
            renderBarChart('karsilastirmaPersonelChartSol', sol.ik.personel_devir, '#00aebb', 'Personel Devir HÄ±zÄ± (%)', maxPersonel);
            renderBarChart('karsilastirmaPersonelChartSag', sag.ik.personel_devir, '#f59e0b', 'Personel Devir HÄ±zÄ± (%)', maxPersonel);
            
            
            await renderHedefChart('karsilastirmaHedefChartSol', solId, solDateBaslangic, '#00aebb');
            await renderHedefChart('karsilastirmaHedefChartSag', sagId, sagDateBaslangic, '#f59e0b');
        }
        
       
        async function renderPerformansChart(canvasId, magazaId, dateBaslangic, dateBitis, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            try {
                const response = await fetch(`/api/analiz/magaza-performans/${magazaId}?baslangic=${dateBaslangic}&bitis=${dateBitis}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const labels = result.data.map(d => d.donem_label || d.donem);
                    const kdsPuani = result.data.map(d => d.kds_puani);
                    
                    const chartKey = canvasId.includes('Sol') ? 'performansSol' : 'performansSag';
                    if (karsilastirmaCharts[chartKey]) {
                        karsilastirmaCharts[chartKey].destroy();
                    }
                    
                    karsilastirmaCharts[chartKey] = new Chart(ctx, {
                    type: 'line',
                    data: {
                            labels: labels,
                        datasets: [{
                                label: 'KDS PuanÄ±',
                                data: kdsPuani,
                                borderColor: color,
                                backgroundColor: color + '20',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'KDS: ' + context.parsed.y.toFixed(1);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: { font: { size: 11 } },
                                    grid: { color: '#e0e0e0' }
                                },
                                x: {
                                    ticks: { font: { size: 10 } },
                                    grid: { display: false }
                                }
                            }
                    }
                });
            }
            } catch (error) {
                console.error('Performans grafiÄŸi hatasÄ±:', error);
            }
        }
        
        
        async function renderHedefChart(canvasId, magazaId, date, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error('Canvas bulunamadÄ±:', canvasId);
                return;
            }
            
            try {
                console.log('Hedef grafiÄŸi yÃ¼kleniyor:', { canvasId, magazaId, date });
                
                
                const magazaResponse = await fetch(`/api/magazalar/${magazaId}`);
                const magazaResult = await magazaResponse.json();
                
                console.log('MaÄŸaza bilgisi:', magazaResult);
                
                if (!magazaResult.success || !magazaResult.data) {
                    console.error('MaÄŸaza bilgisi alÄ±namadÄ±');
                    return;
                }
                
                const ilceId = magazaResult.data.ilce_id;
                
                const dateFormatted = date ? `${date}-01` : null;
                
                console.log('Hedef analizi isteÄŸi:', { ilceId, date: dateFormatted });
                
                let url = `/api/analiz/hedef-analizi?ilce_id=${ilceId}`;
                if (dateFormatted) {
                    url += `&donem=${dateFormatted}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('Hedef analizi sonucu:', result);
                
                if (result.success && result.data && result.data.length > 0) {
                    
                    const magazaData = result.data.filter(d => d.magaza_id == magazaId);
                    
                    console.log('FiltrelenmiÅŸ maÄŸaza verisi:', magazaData);
                    
                    if (magazaData.length > 0) {
                       
                        const categories = [...new Set(magazaData.map(d => d.kategori))];
                        const labels = categories;
                        const hedefData = categories.map(cat => {
                            const item = magazaData.find(d => d.kategori === cat);
                            return item ? item.hedef_oran : 0;
                        });
                        const gerceklesenData = categories.map(cat => {
                            const item = magazaData.find(d => d.kategori === cat);
                            return item ? item.gerceklesen_oran : 0;
                        });
                        
                        console.log('Grafik verisi:', { labels, hedefData, gerceklesenData });
                        
                        const chartKey = canvasId.includes('Sol') ? 'hedefSol' : 'hedefSag';
                        if (karsilastirmaCharts[chartKey]) {
                            karsilastirmaCharts[chartKey].destroy();
                        }
                        
                        karsilastirmaCharts[chartKey] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Hedef',
                                        data: hedefData,
                                        backgroundColor: '#6c757d',
                                        borderColor: '#495057',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'GerÃ§ekleÅŸen',
                                        data: gerceklesenData,
                                        backgroundColor: color,
                                        borderColor: color,
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            },
                                            font: { size: 11 }
                                        },
                                        grid: { color: '#e0e0e0' }
                                    },
                                    x: {
                                        ticks: { font: { size: 10 } },
                                        grid: { display: false }
                                    }
                                }
                            }
                        });
                        
                        console.log('Grafik oluÅŸturuldu:', chartKey);
                    } else {
                        console.warn('MaÄŸaza iÃ§in veri bulunamadÄ±');
                    }
                } else {
                    console.warn('Hedef analizi verisi boÅŸ:', result);
                }
            } catch (error) {
                console.error('Hedef grafiÄŸi hatasÄ±:', error);
            }
        }
        
       
        async function loadSenaryoVerileri() {
            try {
                const response = await fetch('/api/analiz/senaryo-verileri');
                const result = await response.json();
                
                if (result.success && result.data) {
                    senaryoData = result.data;
                    updateSenaryo(); 
                } else {
                    console.error('Senaryo verileri alÄ±namadÄ±:', result);
                }
            } catch (error) {
                console.error('Senaryo verileri yÃ¼kleme hatasÄ±:', error);
            }
        }
        
        
        function updateSenaryo() {
            if (senaryoData.length === 0) return;
            
            
            const ciroSlider = parseFloat(document.getElementById('ciroSlider').value);
            const kiraSlider = parseFloat(document.getElementById('kiraSlider').value);
            const personelSlider = parseFloat(document.getElementById('personelSlider').value);
            
            
            document.getElementById('ciroValue').textContent = ciroSlider >= 0 ? `+${ciroSlider}%` : `${ciroSlider}%`;
            document.getElementById('kiraValue').textContent = `+${kiraSlider}%`;
            document.getElementById('personelValue').textContent = `+${personelSlider}%`;
            
            
            const simuleData = senaryoData.map(magaza => {
                const mevcutKDS = magaza.kds_puani || 0;
                
                
                let mevcutFinansalPuan = 100;
                if (magaza.kira_gideri > 0 && magaza.toplam_ciro > 0) {
                    const mevcutKiraOrani = magaza.kira_gideri / magaza.toplam_ciro;
                    if (mevcutKiraOrani <= 0.05) {
                        mevcutFinansalPuan = 100;
                    } else if (mevcutKiraOrani >= 0.20) {
                        mevcutFinansalPuan = 0;
                    } else {
                        mevcutFinansalPuan = 100 - ((mevcutKiraOrani - 0.05) * 666);
                        mevcutFinansalPuan = Math.max(0, Math.min(100, mevcutFinansalPuan));
                    }
                }
                
                
                const digerPuanlarToplami = (mevcutKDS - (mevcutFinansalPuan * 0.40)) / 0.60;
                
                
                const yeniKira = magaza.kira_gideri * (1 + kiraSlider / 100);
                const yeniCiro = magaza.toplam_ciro * (1 + ciroSlider / 100);
                
                
                let yeniFinansalPuan = 100;
                if (yeniKira > 0 && yeniCiro > 0) {
                    const kiraOrani = yeniKira / yeniCiro;
                    if (kiraOrani <= 0.05) {
                        yeniFinansalPuan = 100;
                    } else if (kiraOrani >= 0.20) {
                        yeniFinansalPuan = 0;
                    } else {
                        yeniFinansalPuan = 100 - ((kiraOrani - 0.05) * 666);
                        yeniFinansalPuan = Math.max(0, Math.min(100, yeniFinansalPuan));
                    }
                }
                
                
                let finansalBonusu = 0;
                if (ciroSlider > 0 && yeniKira > 0 && yeniCiro > 0) {
                    const yeniKiraOrani = yeniKira / yeniCiro;
                    
                    if (yeniKiraOrani <= 0.05) {
                        finansalBonusu = Math.min(3, (ciroSlider / 100) * 10);
                    } else {
                        
                        finansalBonusu = Math.min(5, (ciroSlider / 100) * 15);
                    }
                } else if (ciroSlider < 0) {
                    
                    finansalBonusu = Math.max(-5, (ciroSlider / 100) * 15);
                }
                
                yeniFinansalPuan = Math.max(0, Math.min(100, yeniFinansalPuan + finansalBonusu));
                
                
                const yeniKDS = (yeniFinansalPuan * 0.40) + (digerPuanlarToplami * 0.60);
                
                return {
                    magaza_adi: magaza.magaza_adi,
                    mevcutKDS: mevcutKDS,
                    simuleKDS: Math.round(yeniKDS * 100) / 100,
                    fark: yeniKDS - mevcutKDS,
                    kds_puani: mevcutKDS 
                };
            });
            
            
            const kdsFilter = document.getElementById('senaryoKdsFilter').value;
            
            
            let kritikMagazalar;
            if (kdsFilter === 'highest') {
                
                kritikMagazalar = [...simuleData]
                    .sort((a, b) => {
                        
                        if (a.kds_puani !== b.kds_puani) {
                            return b.kds_puani - a.kds_puani; 
                        }
                        
                        return a.simuleKDS - b.simuleKDS;
                    })
                    .slice(0, 15);
            } else {
                
                kritikMagazalar = [...simuleData]
                    .sort((a, b) => {
                        
                        if (a.kds_puani !== b.kds_puani) {
                            return a.kds_puani - b.kds_puani; 
                        }
                        
                        return a.simuleKDS - b.simuleKDS;
                    })
                    .slice(0, 15);
            }
            
            
            const riskliMagazaSayisi = kritikMagazalar.filter(m => m.simuleKDS < 50).length;
            
            document.getElementById('riskliMagaza').textContent = riskliMagazaSayisi;
              
            renderSenaryoChart(kritikMagazalar);
        }
        
        
        function renderSenaryoChart(data) {
            const ctx = document.getElementById('senaryoChart');
            if (!ctx) return;
            
            
            if (senaryoChart) {
                senaryoChart.destroy();
            }
            
            const labels = data.map(d => d.magaza_adi);
            const mevcutKDSData = data.map(d => d.mevcutKDS);
            const simuleKDSData = data.map(d => d.simuleKDS);
            const colors = data.map(d => {
                if (d.simuleKDS < 50) return '#dc3545'; 
                if (d.simuleKDS < 80) return '#f59e0b'; 
                return '#198754';
            });
            
            senaryoChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                    datasets: [
                        {
                            label: 'Mevcut KDS PuanÄ±',
                            data: mevcutKDSData,
                            backgroundColor: '#6c757d',
                            borderColor: '#495057',
                            borderWidth: 1
                        },
                        {
                            label: 'SimÃ¼le Edilen KDS PuanÄ±',
                            data: simuleKDSData,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return context.dataset.label + ': ' + value.toFixed(2) + ' puan';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 30,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' puan';
                                },
                                font: { size: 11 }
                            },
                            grid: { color: '#e0e0e0' }
                        },
                        x: {
                            ticks: { 
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        
        function resetSenaryo() {
            document.getElementById('ciroSlider').value = 0;
            document.getElementById('kiraSlider').value = 0;
            document.getElementById('personelSlider').value = 0;
            updateSenaryo();
        }
        
       
        function renderBarChart(canvasId, value, color, label, maxValue = null) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            
            let chartKey;
            if (canvasId.includes('Sol')) {
                if (canvasId.includes('KDS')) chartKey = 'kdsSol';
                else if (canvasId.includes('Ciro')) chartKey = 'ciroSol';
                else if (canvasId.includes('Depo')) chartKey = 'depoSol';
                else if (canvasId.includes('Kira')) chartKey = 'kiraSol';
                else if (canvasId.includes('Stok')) chartKey = 'stokSol';
                else if (canvasId.includes('Personel')) chartKey = 'personelSol';
                else if (canvasId.includes('Memnuniyet')) chartKey = 'memnuniyetSol';
            } else {
                if (canvasId.includes('KDS')) chartKey = 'kdsSag';
                else if (canvasId.includes('Ciro')) chartKey = 'ciroSag';
                else if (canvasId.includes('Depo')) chartKey = 'depoSag';
                else if (canvasId.includes('Kira')) chartKey = 'kiraSag';
                else if (canvasId.includes('Stok')) chartKey = 'stokSag';
                else if (canvasId.includes('Personel')) chartKey = 'personelSag';
                else if (canvasId.includes('Memnuniyet')) chartKey = 'memnuniyetSag';
            }
            
            if (chartKey && karsilastirmaCharts[chartKey]) {
                karsilastirmaCharts[chartKey].destroy();
            }
            
           
            let yMax;
            if (maxValue !== null && maxValue !== undefined) {
               
                yMax = maxValue * 1.1;
            } else {
               
                yMax = value * 1.1;
            }
            
            
            if (label.includes('Memnuniyet') || label.includes('MÃ¼ÅŸteri')) {
                yMax = 10;
            }
            
           
            const yMin = 0;
            
            const chart = new Chart(ctx, {
                        type: 'bar',
                data: {
                    labels: [label],
                            datasets: [{
                        label: label,
                        data: [value],
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    if (label.includes('Ciro')) {
                                        return val.toLocaleString('tr-TR') + ' â‚º';
                                    } else if (label.includes('km')) {
                                        return val.toFixed(1) + ' km';
                                    } else if (label.includes('%')) {
                                        return val.toFixed(1) + '%';
                                    } else if (label.includes('/10')) {
                                        return val.toFixed(1) + '/10';
                                    }
                                    return val.toFixed(1);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: yMin,
                            max: yMax,
                            ticks: {
                                font: { size: 11 },
                                stepSize: label.includes('Memnuniyet') || label.includes('MÃ¼ÅŸteri') ? 2 : undefined,
                                callback: function(value) {
                                    if (label.includes('Ciro')) {
                                        return Math.round(value / 1000) + 'K';
                                    }
                                    
                                    return Math.round(value);
                                }
                            },
                            grid: { display: false }
                        },
                        x: {
                            ticks: { font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            if (chartKey) {
                karsilastirmaCharts[chartKey] = chart;
            }
        }
        
        
        function renderRadarChart(canvasId, kategoriler, color, label) {
            const ctx = document.getElementById(canvasId);
            if (!ctx || !kategoriler || kategoriler.length === 0) return;
            
            const chartKey = canvasId.includes('Sol') ? 'radarSol' : 'radarSag';
            if (chartKey === 'radarSol' && karsilastirmaRadarSol) {
                karsilastirmaRadarSol.destroy();
            } else if (chartKey === 'radarSag' && karsilastirmaRadarSag) {
                karsilastirmaRadarSag.destroy();
            }
            
            const labels = kategoriler.map(h => h.kategori);
            const values = kategoriler.map(h => h.tutma_orani);
            
            const chart = new Chart(ctx, {
                type: 'radar',
                        data: {
                            labels: labels,
                            datasets: [{
                        label: label,
                        data: values,
                        fill: true,
                        backgroundColor: color + '33',
                        borderColor: color,
                        pointBackgroundColor: color,
                        pointBorderColor: '#fff',
                        borderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.r.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 150,
                            ticks: {
                                stepSize: 25,
                                font: { size: 9 }
                            },
                            pointLabels: {
                                font: { size: 10 }
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
            
            if (chartKey === 'radarSol') {
                karsilastirmaRadarSol = chart;
            } else {
                karsilastirmaRadarSag = chart;
            }
        }
        
        
        function switchPage(pageName) {
           
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });
            
            
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            
            
            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.style.display = 'block';
                
              
                if (pageName === 'magaza-analizi') {
                    const yilFilter = document.getElementById('magazaYilFilter');
                    if (yilFilter) {
                        yilFilter.value = '2025';
                    }
                }
                
                
                if (pageName === 'karsilastirma') {
                    loadKarsilastirmaDropdowns();
                }
                
                
                if (pageName === 'senaryo') {
                    loadSenaryoVerileri();
                }
            }
            
            currentPage = pageName;
            console.log(`ðŸ“„ Sayfa deÄŸiÅŸtirildi: ${pageName}`);
        }
        
      
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                document.getElementById('searchResults')?.style && (document.getElementById('searchResults').style.display = 'none');
            }
        });
        
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ A101 KDS Dashboard baÅŸlatÄ±lÄ±yor...');
            
            
            await Promise.all([
                initModule1And2(),
                initModule4(),
                initModule3(),
                initModule5(),
                initModule6(),
                initMasterChart()
            ]);
            
            console.log('âœ… TÃ¼m modÃ¼ller yÃ¼klendi!');
        });
        
       
        async function initKPICards() {
            try {
                
                const [storesRes, cannibRes, rentRes, logisticsRes] = await Promise.all([
                    fetch('/api/magazalar'),
                    fetch('/api/analiz/cannibalization'),
                    fetch('/api/analiz/kira-analizi'),
                    fetch('/api/analiz/lojistik-analizi')
                ]);
                
                const stores = await storesRes.json();
                const cannib = await cannibRes.json();
                const rent = await rentRes.json();
                const logistics = await logisticsRes.json();
                
                
                if (stores.success) {
                    document.getElementById('kpiTotalStores').textContent = stores.data.length;
                }
                
                
                if (cannib.success) {
                    const riskCount = cannib.data.length;
                    document.getElementById('kpiCannibalization').textContent = riskCount;
                    document.getElementById('kpiCannibalizationBadge').textContent = 
                        riskCount > 0 ? `${riskCount} Ã‡ift` : 'GÃ¼venli';
                }
                
                
                if (rent.success) {
                    const lossStores = rent.data.filter(s => s.kira_yuku_orani > 15).length;
                    document.getElementById('kpiLossStores').textContent = lossStores;
                    document.getElementById('kpiLossBadge').textContent = 
                        lossStores > 0 ? `%15+ Kira` : 'Normal';
                }
                
                
                if (logistics.success) {
                    const criticalZones = logistics.data.filter(s => 
                        s.durum_rengi === 'Kirmizi' || s.mevsim_katsayisi > 1.5
                    ).length;
                    document.getElementById('kpiSeasonalCritical').textContent = criticalZones;
                    document.getElementById('kpiSeasonalBadge').textContent = 
                        criticalZones > 0 ? 'Takviye Gerekli' : 'Normal';
                }
                
                console.log('ðŸ“Š KPI kartlarÄ± yÃ¼klendi');
            } catch (error) {
                console.error('KPI yÃ¼klenirken hata:', error);
            }
        }
        
        async function initModule1And2() {
            try {
                
                if (!competitionMap) {
                    competitionMap = L.map('competitionMap').setView([38.4237, 27.1428], 10);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap'
                    }).addTo(competitionMap);
                }
                
               
                mapMarkers.forEach(m => competitionMap.removeLayer(m));
                mapMarkers = [];
                rakipMarkers.forEach(m => competitionMap.removeLayer(m));
                rakipMarkers = [];
                
               
                categorizedStores = { red: [], orange: [], blue: [] };
                highCompetitorStoreIds = new Set();
                
               
                const [storesRes, cannibRes, competitorRes] = await Promise.all([
                    fetch('/api/magazalar'),
                    fetch('/api/analiz/cannibalization'),
                    fetch('/api/analiz/competitor?include_locations=true')
                ]);
                
                const stores = await storesRes.json();
                const cannib = await cannibRes.json();
                const competitor = await competitorRes.json();
                
               
                const cannibStoreIds = new Set();
                if (cannib.success && cannib.data) {
                    cannib.data.forEach(pair => {
                        cannibStoreIds.add(pair.storeA_id);
                        cannibStoreIds.add(pair.storeB_id);
                    });
                }
                
                
                const competitorMap = {};
                const competitorDetails = {}; 
                if (competitor.success && competitor.data) {
                    competitor.data.forEach(s => {
                        competitorMap[s.magaza_id] = s.toplam_rakip;
                        competitorDetails[s.magaza_id] = {
                            bim: s.bim_sayisi || 0,
                            sok: s.sok_sayisi || 0,
                            migros: s.migros_sayisi || 0
                        };
                        if (s.toplam_rakip >= 3) {
                            highCompetitorStoreIds.add(s.magaza_id);
                        }
                    });
                    
                   
                    if (competitor.rakipLocations) {
                        rakipLocationsData = competitor.rakipLocations;
                    }
                }
                
              
                if (stores.success && stores.data) {
                    stores.data.forEach(store => {
                        if (store.enlem && store.boylam) {
                            let color = COLORS.primary; 
                            let category = 'blue';
                            let popupExtra = '';
                            
                            
                            if (cannibStoreIds.has(store.magaza_id)) {
                                color = COLORS.danger; 
                                category = 'red';
                                popupExtra = '<br><span style="color:#dc3545;font-weight:600;">âš ï¸ YamyamlÄ±k Riski</span>';
                            } else if (highCompetitorStoreIds.has(store.magaza_id)) {
                                color = COLORS.warning;
                                category = 'orange';
                                const details = competitorDetails[store.magaza_id] || {};
                                popupExtra = `<br><span style="color:#f59e0b;font-weight:600;">ðŸª ${competitorMap[store.magaza_id] || 0} Rakip</span>`;
                                popupExtra += `<br><small style="color:#666;">BÄ°M: ${details.bim} | ÅžOK: ${details.sok} | MÄ°GROS: ${details.migros}</small>`;
                            }
                            
                            const markerIcon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="
                                    width: 16px;
                                    height: 16px;
                                    background: ${color};
                                    border: 2px solid white;
                                    border-radius: 50%;
                                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                "></div>`,
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            });
                            
                            const marker = L.marker([store.enlem, store.boylam], { icon: markerIcon })
                                .addTo(competitionMap)
                                .bindPopup(`
                                    <div style="min-width: 160px;">
                                        <strong>${store.magaza_adi}</strong>
                                        ${popupExtra}
                                        <br><br>
                                        <button onclick="event.stopPropagation(); goToMagazaAnalizi(${store.magaza_id});" style="width: 100%; padding: 6px; background: #00aebb; color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; margin-top: 8px;">
                                            <i class="bi bi-graph-up"></i> MaÄŸaza Analizi
                                        </button>
                                    </div>
                                `);
                            
                           
                            marker.on('click', function(e) {
                               
                                if (!e.originalEvent || !e.originalEvent.target || !e.originalEvent.target.closest('button')) {
                                    goToMagazaAnalizi(store.magaza_id);
                                }
                            });
                            
                            
                            marker.storeId = store.magaza_id;
                            marker.storeName = store.magaza_adi;
                            
                            mapMarkers.push(marker);
                            
                           
                            categorizedStores[category].push({
                                marker: marker,
                                name: store.magaza_adi,
                                lat: store.enlem,
                                lng: store.boylam,
                                id: store.magaza_id,
                                competitorDetails: competitorDetails[store.magaza_id] || {}
                            });
                        }
                    });
                    
                    
                    if (mapMarkers.length > 0) {
                        const group = L.featureGroup(mapMarkers);
                        competitionMap.fitBounds(group.getBounds().pad(0.1));
                    }
                    
                   
                    document.getElementById('countRed').textContent = `(${categorizedStores.red.length})`;
                    document.getElementById('countOrange').textContent = `(${categorizedStores.orange.length})`;
                    document.getElementById('countBlue').textContent = `(${categorizedStores.blue.length})`;
                }
                
                console.log('ðŸ—ºï¸ ModÃ¼l 1 & 2: Harita yÃ¼klendi');
            } catch (error) {
                console.error('Harita yÃ¼klenirken hata:', error);
            }
        }
        
        function filterMapByType(category) {
            const stores = categorizedStores[category];
            
            if (!stores || stores.length === 0) {
                alert('Bu kategoride maÄŸaza bulunamadÄ±.');
                return;
            }
            
            clearRakipMarkers();
            
           
            document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.legend-item.${category}`).classList.add('active');
            
            
            if (category === 'orange') {
                showRakipMarkers();
                document.getElementById('rakipLegend').style.display = 'flex';
            } else {
                document.getElementById('rakipLegend').style.display = 'none';
            }
            
            
            currentCategory = category;
            currentIndex = 0;
            
            document.getElementById('mapNavigator').classList.add('active');
            
            const actionButtons = document.getElementById('navActionButtons');
            if (category === 'red') {
                if (actionButtons) actionButtons.style.display = 'flex';
                selectedMagaza1 = null;
                selectedMagaza2 = null;
                populateMagazaDropdowns();
                setTimeout(() => {
                    updateKarsilastirButton();
                }, 50);
            } else {
                if (actionButtons) actionButtons.style.display = 'none';
            }
            
          
            goToStore(currentIndex);
        }
        
      
        function showRakipMarkers() {
            if (!rakipLocationsData || rakipLocationsData.length === 0) return;
            
            
            const highCompetitorIds = new Set(categorizedStores.orange.map(s => s.id));
            
        
            const rakipColors = {
                'BÄ°M': '#1e3a5f', 
                'MÄ°GROS': '#ff8c00', 
                'ÅžOK': '#dc3545' 
            };
            
            rakipLocationsData.forEach(rakip => {
                if (rakip.yakin_magaza_id && highCompetitorIds.has(rakip.yakin_magaza_id)) {
                    const color = rakipColors[rakip.marka] || '#888';
                    
                    const markerIcon = L.divIcon({
                        className: 'rakip-marker',
                        html: `<div class="rakip-marker-icon" style="
                            width: 18px;
                            height: 18px;
                            background: ${color};
                            border: 2px solid white;
                            border-radius: 3px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            font-weight: bold;
                            color: white;
                        ">${rakip.marka.charAt(0)}</div>`,
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    });
                    
                    const marker = L.marker([rakip.enlem, rakip.boylam], { icon: markerIcon })
                        .addTo(competitionMap)
                        .bindPopup(`
                            <div style="min-width: 120px;">
                                <strong style="color: ${color};">${rakip.marka}</strong>
                                <br><small>YakÄ±n A101: ${rakip.yakin_magaza_adi || '-'}</small>
                            </div>
                        `);
                    
                    rakipMarkers.push(marker);
                }
            });
        }
        
 
        function clearRakipMarkers() {
            rakipMarkers.forEach(m => competitionMap.removeLayer(m));
            rakipMarkers = [];
        }
        
        function goToStore(index) {
            const stores = categorizedStores[currentCategory];
            if (!stores || stores.length === 0) return;
            
            
            if (index < 0) index = stores.length - 1;
            if (index >= stores.length) index = 0;
            
            currentIndex = index;
            const store = stores[currentIndex];
            
            
            competitionMap.setView([store.lat, store.lng], 16, {
                animate: true,
                duration: 0.5
            });
            
            
            store.marker.openPopup();
            
           
            document.getElementById('navInfo').textContent = `${currentIndex + 1} / ${stores.length}`;
            document.getElementById('navStoreName').textContent = store.name;
            
            
            document.getElementById('navPrev').disabled = false;
            document.getElementById('navNext').disabled = false;
        }
        
       
        function navigateStore(direction) {
            goToStore(currentIndex + direction);
        }
        
        
        function closeNavigator() {
            document.getElementById('mapNavigator').classList.remove('active');
            document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('active'));
            currentCategory = null;
            currentIndex = 0;
            
            
            const actionButtons = document.getElementById('navActionButtons');
            if (actionButtons) actionButtons.style.display = 'none';
            
            selectedMagaza1 = null;
            selectedMagaza2 = null;
            
        
            clearRakipMarkers();
            document.getElementById('rakipLegend').style.display = 'none';
            
        
            if (mapMarkers.length > 0) {
                const group = L.featureGroup(mapMarkers);
                competitionMap.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
       
        let selectedMagaza1 = null;
        let selectedMagaza2 = null;
        
        
        function populateMagazaDropdowns() {
            const magaza1Select = document.getElementById('magaza1Select');
            const magaza2Select = document.getElementById('magaza2Select');
            
            if (!magaza1Select || !magaza2Select) return;
            
           
            const yamyamlikMagazalar = categorizedStores.red || [];
            
         
            magaza1Select.innerHTML = '<option value="">1. MaÄŸazayÄ± SeÃ§</option>';
            yamyamlikMagazalar.forEach(magaza => {
                
                if (selectedMagaza2 && magaza.id === selectedMagaza2.id) return;
                const option = document.createElement('option');
                option.value = magaza.id;
                option.textContent = magaza.name;
                if (selectedMagaza1 && magaza.id === selectedMagaza1.id) {
                    option.selected = true;
                }
                magaza1Select.appendChild(option);
            });
            
            
            magaza2Select.innerHTML = '<option value="">2. MaÄŸazayÄ± SeÃ§</option>';
            yamyamlikMagazalar.forEach(magaza => {
               
                if (selectedMagaza1 && magaza.id === selectedMagaza1.id) return;
                const option = document.createElement('option');
                option.value = magaza.id;
                option.textContent = magaza.name;
                if (selectedMagaza2 && magaza.id === selectedMagaza2.id) {
                    option.selected = true;
                }
                magaza2Select.appendChild(option);
            });
            
           
            setTimeout(() => {
                updateKarsilastirButton();
            }, 10);
        }
        
   
        function selectMagaza1(magazaId) {
            if (!magazaId) {
                selectedMagaza1 = null;
                document.getElementById('magaza1Label').style.display = 'none';
                document.getElementById('magaza1Name').textContent = '-';
            } else {
                const yamyamlikMagazalar = categorizedStores.red || [];
                selectedMagaza1 = yamyamlikMagazalar.find(m => m.id === parseInt(magazaId));
                if (selectedMagaza1) {
                    document.getElementById('magaza1Label').style.display = 'block';
                    document.getElementById('magaza1Name').textContent = selectedMagaza1.name;
                }
            }
            populateMagazaDropdowns();
        }
        

        function selectMagaza2(magazaId) {
            if (!magazaId) {
                selectedMagaza2 = null;
                document.getElementById('magaza2Label').style.display = 'none';
                document.getElementById('magaza2Name').textContent = '-';
            } else {
                const yamyamlikMagazalar = categorizedStores.red || [];
                selectedMagaza2 = yamyamlikMagazalar.find(m => m.id === parseInt(magazaId));
                if (selectedMagaza2) {
                    document.getElementById('magaza2Label').style.display = 'block';
                    document.getElementById('magaza2Name').textContent = selectedMagaza2.name;
                }
            }
            populateMagazaDropdowns();
        }
        

        function updateKarsilastirButton() {
            const btn = document.getElementById('karsilastirBtn');
            if (!btn) return;
            
            if (selectedMagaza1 && selectedMagaza2) {
                btn.style.background = '#00aebb';
                btn.style.color = 'white';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
                btn.removeAttribute('disabled');
            } else {
                btn.style.background = '#e0e0e0';
                btn.style.color = '#697a8d';
                btn.style.cursor = 'not-allowed';
                btn.style.opacity = '0.6';
                btn.style.pointerEvents = 'auto';
            }
        }
        
        function goToKarsilastirma(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!selectedMagaza1 || !selectedMagaza2) {
                alert('LÃ¼tfen 2 maÄŸaza seÃ§in.');
                return;
            }
            
 
            switchPage('karsilastirma');
            

            selectKarsilastirmaMod('magaza');

            setTimeout(() => {
                const solSelect = document.getElementById('karsilastirmaSolSelect');
                const sagSelect = document.getElementById('karsilastirmaSagSelect');
                const solDateBaslangic = document.getElementById('karsilastirmaSolDateBaslangic');
                const solDateBitis = document.getElementById('karsilastirmaSolDateBitis');
                const sagDateBaslangic = document.getElementById('karsilastirmaSagDateBaslangic');
                const sagDateBitis = document.getElementById('karsilastirmaSagDateBitis');
                
                if (solSelect && sagSelect) {
                    loadKarsilastirmaDropdowns().then(() => {
                        
                        solSelect.value = selectedMagaza1.id;
                        sagSelect.value = selectedMagaza2.id;
                        
                        setTimeout(() => {
                            if (solDateBaslangic) {
                                
                                for (let i = 0; i < solDateBaslangic.options.length; i++) {
                                    const option = solDateBaslangic.options[i];
                                    if (option.value === '2025-01' || 
                                        option.text.includes('Ocak 2025') ||
                                        option.text.includes('2025-01') ||
                                        option.value.includes('2025-01')) {
                                        solDateBaslangic.value = option.value;
                                        break;
                                    }
                                }
                            }
                            
                            if (solDateBitis) {
                                for (let i = 0; i < solDateBitis.options.length; i++) {
                                    const option = solDateBitis.options[i];
                                    if (option.value === '2025-12' || 
                                        option.text.includes('AralÄ±k 2025') ||
                                        option.text.includes('2025-12') ||
                                        option.value.includes('2025-12')) {
                                        solDateBitis.value = option.value;
                                        break;
                                    }
                                }
                            }
                            
                            if (sagDateBaslangic) {
                                for (let i = 0; i < sagDateBaslangic.options.length; i++) {
                                    const option = sagDateBaslangic.options[i];
                                    if (option.value === '2025-01' || 
                                        option.text.includes('Ocak 2025') ||
                                        option.text.includes('2025-01') ||
                                        option.value.includes('2025-01')) {
                                        sagDateBaslangic.value = option.value;
                                        break;
                                    }
                                }
                            }
                            
                            if (sagDateBitis) {
                                for (let i = 0; i < sagDateBitis.options.length; i++) {
                                    const option = sagDateBitis.options[i];
                                    if (option.value === '2025-12' || 
                                        option.text.includes('AralÄ±k 2025') ||
                                        option.text.includes('2025-12') ||
                                        option.value.includes('2025-12')) {
                                        sagDateBitis.value = option.value;
                                        break;
                                    }
                                }
                            }
                            
                            setTimeout(() => {
                                loadKarsilastirma();
                            }, 100);
                        }, 200);
                    });
                }
            }, 500);
        }
        
        async function initModule4() {
            const ctx = document.getElementById('rentChart');
            if (!ctx) return;
            
            try {
                const response = await fetch('/api/analiz/kira-analizi');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const sortedData = [...result.data]
                        .sort((a, b) => b.kira_yuku_orani - a.kira_yuku_orani)
                        .slice(0, 10);
                    
                    const labels = sortedData.map(d => d.magaza_adi?.substring(0, 15) || `M${d.magaza_id}`);
                    const values = sortedData.map(d => d.kira_yuku_orani || 0);
                    const colors = sortedData.map(d => d.kira_yuku_orani > 15 ? COLORS.danger : COLORS.success);
                    
                    if (rentChart) rentChart.destroy();
                    
                    rentChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Kira YÃ¼kÃ¼ (%)',
                                data: values,
                                backgroundColor: colors,
                                borderRadius: 6,
                                barThickness: 10
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const elementIndex = elements[0].index;
                                    const clickedMagaza = sortedData[elementIndex];
                                    if (clickedMagaza && clickedMagaza.magaza_id) {
                                        
                                        switchPage('magaza-analizi');
                                        
                                        setTimeout(() => {
                                            selectMagaza(clickedMagaza.magaza_id);
                                        }, 100);
                                    }
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            const idx = context.dataIndex;
                                            const item = sortedData[idx];
                                            return [
                                                `Kira YÃ¼kÃ¼: %${item.kira_yuku_orani}`,
                                                `Ciro: â‚º${(item.toplam_ciro || 0).toLocaleString('tr-TR')}`,
                                                `Kira: â‚º${(item.kira_gideri || 0).toLocaleString('tr-TR')}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: 50,
                                    grid: { color: '#f1f5f9' },
                                    ticks: { 
                                        color: '#697a8d', 
                                        callback: v => '%' + v
                                    }
                                },
                                y: {
                                    grid: { display: false },
                                    ticks: { 
                                        color: '#1a1a2e',
                                        font: { size: 11 }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('ðŸ’° ModÃ¼l 4: Kira/Ciro grafiÄŸi yÃ¼klendi');
                }
            } catch (error) {
                console.error('ModÃ¼l 4 hatasÄ±:', error);
            }
        }
        
        let hedefFiltersLoaded = false;
        
        async function initModule3() {
            await loadHedefFilters();
        }
        
        async function loadHedefFilters() {
            try {
                const ilceRes = await fetch('/api/analiz/ilceler');
                const ilceData = await ilceRes.json();
                
                if (ilceData.success && ilceData.data) {
                    const ilceSelect = document.getElementById('hedefIlceFilter');
                    ilceSelect.innerHTML = '<option value="">ðŸ“ Ä°lÃ§e SeÃ§iniz *</option>' +
                        ilceData.data.map(ilce => 
                            `<option value="${ilce.ilce_id}">${ilce.ilce_adi} (${ilce.magaza_sayisi} maÄŸaza)</option>`
                        ).join('');
                }
                
                
                const demoRes = await fetch('/api/analiz/demografiler');
                const demoData = await demoRes.json();
                
                if (demoData.success && demoData.data) {
                    const demoSelect = document.getElementById('hedefDemografiFilter');
                    demoSelect.innerHTML = '<option value="all">ðŸ‘¥ TÃ¼m Demografiler</option>' +
                        demoData.data.map(d => `<option value="${d}">${d}</option>`).join('');
                }
                
                hedefFiltersLoaded = true;
                console.log('ðŸ“Š ModÃ¼l 3: Filtreler yÃ¼klendi');
                
            } catch (error) {
                console.error('Filtre yÃ¼kleme hatasÄ±:', error);
            }
        }
        
       
        async function loadHedefAnalizi() {
            const yil = document.getElementById('hedefYilFilter').value || '2025';
            const ilceId = document.getElementById('hedefIlceFilter').value;
            const demografi = document.getElementById('hedefDemografiFilter').value;
            
            
            if (!ilceId) {
                alert('âš ï¸ LÃ¼tfen bir ilÃ§e seÃ§iniz!');
                document.getElementById('hedefIlceFilter').focus();
                return;
            }
            
            const ctx = document.getElementById('hedefChart');
            if (!ctx) return;
            
            
            const btn = document.getElementById('hedefAnalizBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> YÃ¼kleniyor...';
            btn.disabled = true;
            
            try {
               
                let url = `/api/analiz/hedef-analizi?ilce_id=${ilceId}&yil=${yil}`;
                if (demografi && demografi !== 'all') {
                    url += `&demografi=${encodeURIComponent(demografi)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const rawData = result.data;
                    
                    
                    document.getElementById('hedefTutan').textContent = result.stats.hedef_tutan;
                    document.getElementById('hedefAlti').textContent = result.stats.hedef_tutmayan;
                    document.getElementById('hedefDonem').textContent = result.donem || '-';
                    
                   
                    document.getElementById('hedefInitialMessage').style.display = 'none';
                    document.getElementById('hedefChartContainer').style.display = 'block';
                    
                  
                    const magazaMap = {};
                    const kategoriler = new Set();
                    
                    rawData.forEach(d => {
                        if (!magazaMap[d.magaza_adi]) {
                            magazaMap[d.magaza_adi] = { 
                                magaza_id: d.magaza_id,
                                ilce_adi: d.ilce_adi, 
                                kategoriler: {} 
                            };
                        }
                        magazaMap[d.magaza_adi].kategoriler[d.kategori] = {
                            hedef: d.hedef_oran,
                            gercek: parseFloat(d.gerceklesen_oran),
                            fark: d.fark,
                            renk: d.renk
                        };
                        kategoriler.add(d.kategori);
                    });
                    
                    const magazaAdlari = Object.keys(magazaMap);
                    const kategoriListesi = Array.from(kategoriler);
                    
                    
                    const datasets = [];
                    kategoriListesi.forEach((kategori, idx) => {
                        
                        datasets.push({
                            label: `${kategori} Hedef`,
                            data: magazaAdlari.map(m => magazaMap[m].kategoriler[kategori]?.hedef || 0),
                            backgroundColor: 'rgba(75, 85, 99, 0.6)',
                            borderColor: '#4b5563',
                            borderWidth: 1,
                            borderRadius: 3,
                            barPercentage: 0.85,
                            categoryPercentage: 0.9,
                            kategori: kategori,
                            tip: 'hedef'
                        });
                        
                        
                        datasets.push({
                            label: `${kategori} GerÃ§ek`,
                            data: magazaAdlari.map(m => magazaMap[m].kategoriler[kategori]?.gercek || 0),
                            backgroundColor: magazaAdlari.map(m => {
                                const kat = magazaMap[m].kategoriler[kategori];
                                if (!kat) return 'rgba(16, 185, 129, 0.8)';
                                return kat.renk === 'red' ? 'rgba(220, 53, 69, 0.8)' : 'rgba(16, 185, 129, 0.8)';
                            }),
                            borderColor: magazaAdlari.map(m => {
                                const kat = magazaMap[m].kategoriler[kategori];
                                if (!kat) return '#10b981';
                                return kat.renk === 'red' ? '#dc3545' : '#10b981';
                            }),
                            borderWidth: 1,
                            borderRadius: 3,
                            barPercentage: 0.85,
                            categoryPercentage: 0.9,
                            kategori: kategori,
                            tip: 'gercek'
                        });
                    });
                    
                    if (hedefChart) hedefChart.destroy();
                    
                    hedefChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: magazaAdlari,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const elementIndex = elements[0].index;
                                    const clickedMagazaAdi = magazaAdlari[elementIndex];
                                    const clickedMagaza = magazaMap[clickedMagazaAdi];
                                    if (clickedMagaza && clickedMagaza.magaza_id) {                                       
                                        switchPage('magaza-analizi');
                                        setTimeout(() => {
                                            selectMagaza(clickedMagaza.magaza_id);
                                        }, 100);
                                    }
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        font: { size: 11 },
                                        generateLabels: function(chart) {
                                            
                                            return [
                                                {
                                                    text: 'Hedef',
                                                    fillStyle: 'rgba(75, 85, 99, 0.6)',
                                                    strokeStyle: '#4b5563',
                                                    lineWidth: 1,
                                                    hidden: false,
                                                    index: 0
                                                },
                                                {
                                                    text: 'GerÃ§ekleÅŸen',
                                                    fillStyle: 'rgba(16, 185, 129, 0.8)',
                                                    strokeStyle: '#10b981',
                                                    lineWidth: 1,
                                                    hidden: false,
                                                    index: 1
                                                }
                                            ];
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        title: function(context) {
                                            const magaza = context[0].label;
                                            const kategori = context[0].dataset.kategori;
                                            return `${magaza} - ${kategori}`;
                                        },
                                        afterTitle: function(context) {
                                            const magaza = context[0].label;
                                            return `ðŸ“ ${magazaMap[magaza]?.ilce_adi || '-'}`;
                                        },
                                        label: function(context) {
                                            const tip = context.dataset.tip;
                                            const value = context.parsed.y;
                                            const emoji = tip === 'hedef' ? 'ðŸŽ¯' : 'ðŸ“Š';
                                            const tipAd = tip === 'hedef' ? 'Hedef' : 'GerÃ§ekleÅŸen';
                                            return `${emoji} ${tipAd}: %${value.toFixed(1)}`;
                                        },
                                        afterBody: function(context) {
                                            const magaza = context[0].label;
                                            const kategori = context[0].dataset.kategori;
                                            const kat = magazaMap[magaza]?.kategoriler[kategori];
                                            if (kat) {
                                                const farkStr = kat.fark >= 0 ? `+%${kat.fark.toFixed(1)}` : `%${kat.fark.toFixed(1)}`;
                                                return [
                                                    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
                                                    `Fark: ${farkStr}`,
                                                    `Durum: ${kat.renk === 'green' ? 'âœ… BaÅŸarÄ±lÄ±' : 'âŒ Hedef AltÄ±'}`
                                                ];
                                            }
                                            return [];
                                        }
                                    }
                                },
                                datalabels: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        color: '#1a1a2e',
                                        font: { size: 11, weight: '600' },
                                        maxRotation: 0,
                                        minRotation: 0
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        color: '#697a8d',
                                        font: { size: 10 },
                                        callback: v => '%' + v
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ciro PayÄ± (%)',
                                        color: '#697a8d',
                                        font: { size: 11 }
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                    
                    console.log('ðŸ“Š ModÃ¼l 3: Hedef analizi grafiÄŸi yÃ¼klendi');
                    
                } else {
                  
                    document.getElementById('hedefTutan').textContent = '0';
                    document.getElementById('hedefAlti').textContent = '0';
                    document.getElementById('hedefDonem').textContent = '-';
                    
                    document.getElementById('hedefInitialMessage').innerHTML = `
                        <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 16px; color: #94a3b8;"></i>
                        <p style="font-size: 16px; margin: 0; color: #94a3b8;">Bu filtreler iÃ§in veri bulunamadÄ±</p>
                        <p style="font-size: 12px; color: #b0bec5; margin-top: 8px;">FarklÄ± bir ilÃ§e veya demografi seÃ§meyi deneyin</p>
                    `;
                    document.getElementById('hedefInitialMessage').style.display = 'flex';
                    document.getElementById('hedefChartContainer').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Hedef analizi hatasÄ±:', error);
                alert('Veri yÃ¼klenirken bir hata oluÅŸtu: ' + error.message);
            } finally {
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
      
        let logisticsMagazaLoaded = false;
        
        async function initModule5() {
            const ctx = document.getElementById('logisticsChart');
            if (!ctx) return;
            
            try {
                const selectedYear = document.getElementById('logisticsYearFilter')?.value || '2025';
                const selectedMagaza = document.getElementById('logisticsMagazaFilter')?.value || 'all';
                
                const response = await fetch(`/api/analiz/lojistik-analizi?yil=${selectedYear}&magaza_id=${selectedMagaza}`);
                const result = await response.json();
                
                if (result.success && result.trendData) {
                    const trendData = result.trendData;
                    
                  
                    if (!logisticsMagazaLoaded && result.turistikMagazalar) {
                        const magazaSelect = document.getElementById('logisticsMagazaFilter');
                        if (magazaSelect) {
                            magazaSelect.innerHTML = '<option value="all">ðŸª TÃ¼m Turistik (' + result.turistikMagazalar.length + ')</option>' +
                                result.turistikMagazalar.map(m => 
                                    `<option value="${m.magaza_id}">${m.magaza_adi}</option>`
                                ).join('');
                            logisticsMagazaLoaded = true;
                        }
                    }
                    
                    const aylar = trendData.map(d => d.ay_adi);
                    const stokData = trendData.map(d => parseFloat(d.stok_devir_hizi) || 0);
                    
                   
                    if (result.istatistik) {
                        document.getElementById('yazOrt').textContent = result.istatistik.yaz_ortalamasi || '-';
                        document.getElementById('kisOrt').textContent = result.istatistik.kis_ortalamasi || '-';
                        document.getElementById('mevsimFark').textContent = (result.istatistik.fark > 0 ? '+' : '') + (result.istatistik.fark || 0);
                    }
                    
                    if (logisticsChart) logisticsChart.destroy();
                    
                    logisticsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                            labels: aylar,
                            datasets: [
                                {
                                    label: result.secilenMagaza || 'Turistik MaÄŸazalar',
                                    data: stokData,
                                    fill: true,
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 6,
                                    pointBackgroundColor: aylar.map((_, i) => 
                                        (i >= 5 && i <= 7) ? '#dc3545' : '#f59e0b'
                                    ),
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    borderWidth: 3
                                }
                            ]
                    },
                    options: {
                        responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        font: { size: 10 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            const idx = context.dataIndex;
                                            const isSummer = idx >= 5 && idx <= 7;
                                            const value = context.raw;
                                            
                                            if (isSummer) {
                                                return `ðŸ”¥ Stok Devir: ${value} (YAZ SEZONU!)`;
                                            }
                                            return `Stok Devir HÄ±zÄ±: ${value}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#697a8d', font: { size: 10 } }
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 120,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        color: '#697a8d', 
                                        font: { size: 10 },
                                        callback: v => v + '%'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Stok Devir HÄ±zÄ±',
                                        color: '#697a8d',
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('ðŸšš ModÃ¼l 5: Lojistik trend grafiÄŸi yÃ¼klendi (2 Ã§izgi)');
                }
            } catch (error) {
                console.error('ModÃ¼l 5 hatasÄ±:', error);
            }
        }
        
      
        async function initModule6() {
            const ctx = document.getElementById('hrChart');
            if (!ctx) return;
          
            const baslangicInput = document.getElementById('hrBaslangicTarihi');
            const bitisInput = document.getElementById('hrBitisTarihi');
            
          
            if (!baslangicInput.value || !bitisInput.value) {
                const bugun = new Date();
                const bitisTarihi = new Date(bugun);
                const baslangicTarihi = new Date(bugun);
                baslangicTarihi.setMonth(bugun.getMonth() - 6);
                
                baslangicInput.value = baslangicTarihi.toISOString().split('T')[0];
                bitisInput.value = bitisTarihi.toISOString().split('T')[0];
            }
            
            try {
                const baslangicTarihi = baslangicInput.value;
                const bitisTarihi = bitisInput.value;
                
                if (!baslangicTarihi || !bitisTarihi) {
                    console.warn('âš ï¸ ModÃ¼l 6: Tarih seÃ§ilmedi');
                    return;
                }
                
                const response = await fetch(`/api/analiz/ik-analizi?baslangic=${baslangicTarihi}&bitis=${bitisTarihi}`);
                const result = await response.json();
                
                if (result.success && result.scatterData) {
                    const data = result.scatterData;
                    
                  
                    const jitter = () => (Math.random() - 0.5) * 0.6;
                    
                 
                    const normalStores = data.filter(d => d.durum === 'NORMAL').map(d => ({
                        x: d.personel_devir_hizi + jitter(),
                        y: d.musteri_memnuniyet + jitter(),
                        label: d.magaza_adi,
                        ilce: d.ilce_adi,
                        durum: d.durum,
                        originalX: d.personel_devir_hizi,
                        originalY: d.musteri_memnuniyet
                    }));
                    
                    const riskliStores = data.filter(d => d.durum === 'RÄ°SKLÄ°').map(d => ({
                        x: d.personel_devir_hizi + jitter(),
                        y: d.musteri_memnuniyet + jitter(),
                        label: d.magaza_adi,
                        ilce: d.ilce_adi,
                        durum: d.durum,
                        originalX: d.personel_devir_hizi,
                        originalY: d.musteri_memnuniyet
                    }));
                    
                    const crisisStores = data.filter(d => d.durum === 'KRÄ°Z MASASI').map(d => ({
                        x: d.personel_devir_hizi + jitter(),
                        y: d.musteri_memnuniyet + jitter(),
                        label: d.magaza_adi,
                        ilce: d.ilce_adi,
                        durum: d.durum,
                        originalX: d.personel_devir_hizi,
                        originalY: d.musteri_memnuniyet
                    }));
                    
                    console.log(`ðŸ“Š ModÃ¼l 6 [${result.donem}]: Normal=${normalStores.length}, Riskli=${riskliStores.length}, Kriz=${crisisStores.length}, Toplam=${data.length}`);
                    
                    if (hrChart) hrChart.destroy();
                    
                    
                    ctx.style.marginTop = '10px';
                    ctx.style.display = 'block';
                    
                    hrChart = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [
                                {
                                    label: `âœ… Normal (${normalStores.length})`,
                                    data: normalStores,
                                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                    borderColor: '#10b981',
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointBorderWidth: 1.5
                                },
                                {
                                    label: `âš ï¸ Riskli (${riskliStores.length})`,
                                    data: riskliStores,
                                    backgroundColor: 'rgba(245, 158, 11, 0.7)',
                                    borderColor: '#f59e0b',
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointBorderWidth: 1.5
                                },
                                {
                                    label: `ðŸš¨ Kriz (${crisisStores.length})`,
                                    data: crisisStores,
                                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                    borderColor: '#dc3545',
                                    pointRadius: 5,
                                    pointHoverRadius: 7,
                                    pointStyle: 'triangle',
                                    pointBorderWidth: 1.5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    left: 25,
                                    right: 10,
                                    top: 10,
                                    bottom: 25
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 11 },
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].raw.label;
                                        },
                                        label: function(context) {
                                            const point = context.raw;
                                            return [
                                                `ðŸ“ ${point.ilce}`,
                                                `ðŸ‘¥ Personel Devir: %${point.originalX}`,
                                                `â­ Memnuniyet: ${point.originalY}/10`,
                                                `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,
                                                point.durum === 'KRÄ°Z MASASI' ? 'ðŸš¨ ACÄ°L MÃœDAHALE GEREKLÄ°!' : `ðŸ“Š Durum: ${point.durum}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Personel Devir HÄ±zÄ± (%) â†’',
                                        color: '#697a8d',
                                        font: { size: 11, weight: '600' },
                                        padding: { top: 5, bottom: 5 }
                                    },
                                    min: 0,
                                    max: 15,
                                    offset: false,
                                    grid: { color: '#f1f5f9' },
                                    ticks: { 
                                        color: '#697a8d',
                                        stepSize: 5,
                                        callback: v => '%' + v
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'â†‘ MÃ¼ÅŸteri Memnuniyeti',
                                        color: '#697a8d',
                                        font: { size: 11, weight: '600' },
                                        padding: { right: 15, left: 5 }
                                    },
                                    min: 0,
                                    max: 10,
                                    suggestedMax: 10,
                                    offset: false,
                                    grid: { color: '#f1f5f9' },
                                    ticks: { 
                                        color: '#697a8d',
                                        stepSize: 2,
                                        callback: v => v + '/10',
                                        maxTicksLimit: 6
                                    }
                                }
                            }
                        }
                    });
                    
                    
                    console.log('ðŸ‘¥ ModÃ¼l 6: Negatif korelasyonlu scatter plot yÃ¼klendi');
                    console.log(`   ðŸ“Š Toplam: ${data.length} | ðŸš¨ Kriz: ${crisisStores.length} | âœ… Normal: ${normalStores.length}`);
                }
            } catch (error) {
                console.error('ModÃ¼l 6 hatasÄ±:', error);
            }
        }
        
        
        let masterKDSData = [];
        let currentMasterFilter = 'all';
        
        async function initMasterChart() {
            const canvas = document.getElementById('masterChart');
            const scrollContainer = document.getElementById('masterChartScroll');
            const chartWrapper = document.getElementById('masterChartWrapper');
            const donemSelect = document.getElementById('masterDonemFilter');
            if (!canvas || !scrollContainer || !chartWrapper) return;
            
            try {
               
                const donem = donemSelect.value || '12';
                
           
                const url = `/api/analiz/tum-magazalar-kds?donem=${donem}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
               
                    masterKDSData = result.data;
                    const stats = result.stats;
                    
                    
                    currentMasterFilter = 'all';
                    const filterAllBtn = document.getElementById('masterFilterAll');
                    if (filterAllBtn) filterAllBtn.style.display = 'none';
                    document.querySelectorAll('.master-filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'dimmed');
                    });
                    
                 
                    let mukemmel = 0, iyi = 0, orta = 0, kritik = 0, acil = 0;
                    masterKDSData.forEach(d => {
                        const puan = parseFloat(d.kds_puani) || 0;
                        if (puan >= 85) {
                            mukemmel++;
                        } else if (puan >= 70) {
                            iyi++;
                        } else if (puan >= 60) {
                            orta++;
                        } else if (puan >= 40) {
                            kritik++;
                        } else {
                            acil++;
                        }
                    });
                    
                    
                    const statMukemmel = document.getElementById('masterStatMukemmel');
                    const statIyi = document.getElementById('masterStatIyi');
                    const statOrta = document.getElementById('masterStatOrta');
                    const statKritik = document.getElementById('masterStatKritik');
                    const statAcil = document.getElementById('masterStatAcil');
                    const statAvg = document.getElementById('masterStatAvg');
                    if (statMukemmel) statMukemmel.textContent = mukemmel;
                    if (statIyi) statIyi.textContent = iyi;
                    if (statOrta) statOrta.textContent = orta;
                    if (statKritik) statKritik.textContent = kritik;
                    if (statAcil) statAcil.textContent = acil;
                    if (statAvg) statAvg.textContent = stats.ortalama_puan;
                    
                   
                    const titleElement = document.querySelector('.master-title');
                    if (titleElement) {
                        titleElement.innerHTML = `<i class="bi bi-bar-chart-fill"></i> Master Performans GrafiÄŸi - TÃ¼m MaÄŸazalar KDS SÄ±ralamasÄ± (Son ${donem} ay)`;
                    }
                    
                    
                    const sortOrder = document.getElementById('masterSortFilter').value;
                    let sortedData = [...masterKDSData];
                    sortedData.sort((a, b) => {
                        const puanA = parseFloat(a.kds_puani) || 0;
                        const puanB = parseFloat(b.kds_puani) || 0;
                        return sortOrder === 'desc' ? puanB - puanA : puanA - puanB;
                    });
                    
                   
                    renderMasterChart(sortedData);
                    
                    console.log(`ðŸ“Š Master Chart: ${masterKDSData.length} maÄŸaza yÃ¼klendi (Son ${donem} ay)`);
                }
            } catch (error) {
                console.error('Master Chart hatasÄ±:', error);
                scrollContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #697a8d;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 32px; margin-right: 12px; color: #f59e0b;"></i>
                        <span>Veri yÃ¼klenirken hata oluÅŸtu. Sunucu baÄŸlantÄ±sÄ±nÄ± kontrol edin.</span>
                    </div>
                `;
            }
        }
        
       
        function applyMasterSort() {
            if (masterKDSData.length === 0) return;
            
           
            const sortOrder = document.getElementById('masterSortFilter').value;
            
         
            let dataToSort = masterKDSData;
            if (currentMasterFilter !== 'all') {
                dataToSort = masterKDSData.filter(d => {
                    const karar = (d.onerilen_karar || '').toUpperCase();
                    if (currentMasterFilter === 'mukemmel') return karar.includes('MÃœKEMMEL');
                    if (currentMasterFilter === 'iyi') return karar.includes('Ä°YÄ°');
                    if (currentMasterFilter === 'orta') return karar.includes('ORTA');
                    if (currentMasterFilter === 'kritik') return karar.includes('KRÄ°TÄ°K');
                    if (currentMasterFilter === 'acil') return karar.includes('ACÄ°L');
                    return true;
                });
            }
            
            
            let sortedData = [...dataToSort];
            sortedData.sort((a, b) => {
                const puanA = parseFloat(a.kds_puani) || 0;
                const puanB = parseFloat(b.kds_puani) || 0;
                return sortOrder === 'desc' ? puanB - puanA : puanA - puanB;
            });
            
        
            renderMasterChart(sortedData);
            
            console.log(`ðŸ“Š Master Chart sÄ±ralandÄ±: ${sortOrder === 'desc' ? 'En Ä°yilerden En KÃ¶tÃ¼lere' : 'En KÃ¶tÃ¼lerden En Ä°yilere'}`);
        }
        

        function renderMasterChart(data) {
            const canvas = document.getElementById('masterChart');
            const chartWrapper = document.getElementById('masterChartWrapper');
            if (!canvas || !chartWrapper || data.length === 0) return;
            
            
            chartWrapper.style.height = '100%';
            canvas.style.height = '100%';
            
           
            const labels = data.map(d => d.magaza_adi);
            const values = data.map(d => d.kds_puani);
            
            
            const colors = data.map(d => {
                const puan = parseFloat(d.kds_puani) || 0;
                if (puan >= 85) {
                    return '#10b981'; 
                } else if (puan >= 70) {
                    return '#3b82f6';  
                } else if (puan >= 60) {
                    return '#f59e0b';  
                } else if (puan >= 40) {
                    return '#f97316';  
                } else {
                    return '#dc3545';  
                }
            });
            
            if (masterChart) masterChart.destroy();
            
            masterChart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                        label: 'KDS PuanÄ±',
                                data: values,
                                backgroundColor: colors,
                        borderRadius: 4,
                        barThickness: 12,
                        maxBarThickness: 15
                            }]
                        },
                        options: {
                    indexAxis: 'x',  
                            responsive: true,
                            maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 5,
                            right: 5
                        }
                    },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const elementIndex = elements[0].index;
                                    const clickedMagaza = data[elementIndex];
                                    if (clickedMagaza && clickedMagaza.magaza_id) {
                                        
                                        switchPage('magaza-analizi');
                                        
                                        setTimeout(() => {
                                            selectMagaza(clickedMagaza.magaza_id);
                                        }, 100);
                                    }
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            padding: 14,
                                    cornerRadius: 8,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                                    callbacks: {
                                        title: function(context) {
                                            const idx = context[0].dataIndex;
                                    return data[idx].magaza_adi;
                                        },
                                        label: function(context) {
                                            const idx = context.dataIndex;
                                            const item = data[idx];
                                    
                                    
                                    let durumEmoji = 'ðŸŸ¢';
                                    const karar = (item.onerilen_karar || '').toUpperCase();
                                    if (karar.includes('MÃœKEMMEL')) {
                                        durumEmoji = 'â­';
                                    } else if (karar.includes('Ä°YÄ°')) {
                                        durumEmoji = 'ðŸŸ¢';
                                    } else if (karar.includes('ORTA')) {
                                        durumEmoji = 'ðŸŸ ';
                                    } else if (karar.includes('KRÄ°TÄ°K')) {
                                        durumEmoji = 'ðŸ”´';
                                    } else if (karar.includes('ACÄ°L')) {
                                        durumEmoji = 'ðŸš¨';
                                    }
                                    
                                            return [
                                        `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,
                                        `ðŸ“ Ä°lÃ§e: ${item.ilce_adi}`,
                                        `ðŸ’° Toplam Ciro: â‚º${item.toplam_ciro?.toLocaleString('tr-TR') || 0}`,
                                        `â­ MÃ¼ÅŸteri Memnuniyeti: ${item.ortalama_memnuniyet}/10`,
                                        `ðŸ“Š KDS PuanÄ±: ${item.kds_puani}`,
                                        `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,
                                        `${durumEmoji} ${item.onerilen_karar || 'DeÄŸerlendirme Yok'}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                        x: {
                                    grid: { display: false },
                                    ticks: {
                                        color: '#1a1a2e',
                                font: { size: 9, weight: '500' },
                                padding: 4,
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: false
                                    }
                                },
                        y: {
                                    beginAtZero: true,
                            max: 100,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        color: '#697a8d',
                                font: { size: 10 },
                                callback: v => v + ' puan',
                                stepSize: 20
                            }
                        }
                            }
                        }
                    });
        }
        
        
        function filterMasterChart(filterType) {
            if (masterKDSData.length === 0) return;
            
            
            if (currentMasterFilter === filterType && filterType !== 'all') {
                filterType = 'all';
            }
            
            currentMasterFilter = filterType;
            
            
            const buttons = document.querySelectorAll('.master-filter-btn');
            buttons.forEach(btn => btn.classList.remove('active', 'dimmed'));
            
            let filteredData = masterKDSData;
            
            if (filterType === 'all') {
                document.getElementById('masterFilterAll').style.display = 'none';
            } else {
                document.getElementById('masterFilterAll').style.display = 'flex';
                
                buttons.forEach(btn => {
                    if (btn.onclick.toString().includes(`'${filterType}'`)) {
                        btn.classList.add('active');
                    } else if (!btn.id.includes('FilterAll')) {
                        btn.classList.add('dimmed');
                    }
                });
                
                
                filteredData = masterKDSData.filter(d => {
                    const puan = parseFloat(d.kds_puani) || 0;
                    
                    if (filterType === 'mukemmel') {
                        return puan >= 85;
                    } else if (filterType === 'iyi') {
                        return puan >= 70 && puan < 85;
                    } else if (filterType === 'orta') {
                        return puan >= 60 && puan < 70;
                    } else if (filterType === 'kritik') {
                        return puan >= 40 && puan < 60;
                    } else if (filterType === 'acil') {
                        return puan < 40;
                    }
                    return true;
                });
            }
            
  
            const sortOrder = document.getElementById('masterSortFilter').value;
            filteredData = [...filteredData].sort((a, b) => {
                const puanA = parseFloat(a.kds_puani) || 0;
                const puanB = parseFloat(b.kds_puani) || 0;
                return sortOrder === 'desc' ? puanB - puanA : puanA - puanB;
            });
            
            
            renderMasterChart(filteredData);
            
            document.getElementById('masterChartScroll').scrollTop = 0;
            
            console.log(`ðŸ” Filtre: ${filterType} - ${filteredData.length} maÄŸaza gÃ¶steriliyor`);
        }
        
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 0
            }).format(value);
        }
    </script>

    <!-- MaÄŸaza CRUD Modal -->
    <div id="magaza-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 50px auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                <h2 id="magaza-modal-title" style="margin: 0; font-size: 18px; color: #1a1a2e;">Yeni MaÄŸaza Ekle</h2>
                <button onclick="closeMagazaModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #697a8d;">&times;</button>
            </div>
            <form id="magaza-form" onsubmit="saveMagaza(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">MaÄŸaza AdÄ± *</label>
                        <input type="text" id="magaza_adi" required style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">Ä°lÃ§e ID</label>
                        <input type="number" id="ilce_id" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">MaÄŸaza mÂ²</label>
                        <input type="number" id="magaza_m2" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">Rakip SayÄ±sÄ± YakÄ±n</label>
                        <input type="number" id="rakip_sayisi_yakin" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">Depoya UzaklÄ±k (km)</label>
                        <input type="number" step="0.01" id="depoya_uzaklik_km" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">AÃ§Ä±lÄ±ÅŸ Tarihi</label>
                        <input type="date" id="acilis_tarihi" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">Enlem</label>
                        <input type="number" step="any" id="enlem" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">Boylam</label>
                        <input type="number" step="any" id="boylam" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; color: #1a1a2e;">Demografik YapÄ±</label>
                    <input type="text" id="demografik_yapi" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeMagazaModal()" style="padding: 8px 16px; background: #697a8d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Ä°ptal</button>
                    <button type="submit" style="padding: 8px 16px; background: #00aebb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
